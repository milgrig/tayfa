<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tayfa ‚Äî –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/png" href="/static/tayfa-icon.png">
    <style>
        :root, [data-theme="dark"] {
            --bg: #0f1117;
            --bg-card: #1a1d27;
            --bg-card-hover: #22263a;
            --bg-input: #12141c;
            --border: #2a2e3e;
            --border-active: #4f6ef7;
            --text: #e1e4ed;
            --text-dim: #7a7f92;
            --text-bright: #ffffff;
            --accent: #4f6ef7;
            --accent-hover: #6b84ff;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --purple: #a78bfa;
            --font: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            --mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            --radius: 10px;
            --shadow: 0 4px 24px rgba(0,0,0,0.3);
        }

        [data-theme="light"] {
            --bg: #f0f2f5;
            --bg-card: #ffffff;
            --bg-card-hover: #e8eaed;
            --bg-input: #ffffff;
            --border: #c9cdd4;
            --border-active: #4f6ef7;
            --text: #24292e;
            --text-dim: #525960;
            --text-bright: #1b1f23;
            --accent: #4f6ef7;
            --accent-hover: #3a5bd9;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        [data-theme="blue"] {
            --bg: #0a192f;
            --bg-card: #112240;
            --bg-card-hover: #1d3557;
            --bg-input: #0a192f;
            --border: #233554;
            --border-active: #64ffda;
            --text: #8892b0;
            --text-dim: #495670;
            --text-bright: #ccd6f6;
            --accent: #64ffda;
            --accent-hover: #4fd1c5;
            --success: #64ffda;
            --warning: #ffd166;
            --danger: #ff6b6b;
            --purple: #bd93f9;
        }

        [data-theme="girly"] {
            --bg: #1a1218;
            --bg-card: #251a22;
            --bg-card-hover: #2f2329;
            --bg-input: #1a1218;
            --border: #3d2d38;
            --border-active: #e879a9;
            --text: #e8d5e0;
            --text-dim: #9a8492;
            --text-bright: #fff0f5;
            --accent: #e879a9;
            --accent-hover: #f4a0c4;
            --success: #7dd3a8;
            --warning: #f9c784;
            --danger: #f87171;
            --purple: #c4a7e7;
            --shadow: 0 4px 24px rgba(232,121,169,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }
        .header h1 { font-size: 20px; font-weight: 700; color: var(--text-bright); letter-spacing: -0.3px; }
        .header h1 span { color: var(--accent); }

        .header-left { display: flex; align-items: center; gap: 16px; }

        .current-project {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .current-project:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-active);
        }
        .current-project .project-icon { font-size: 14px; }
        .current-project .project-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-bar { display: flex; gap: 16px; align-items: center; position: relative; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.on { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.off { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
        .status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .status-item { font-size: 13px; color: var(--text-dim); display: flex; align-items: center; }

        /* ‚îÄ‚îÄ Git Status Indicator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .git-status-indicator { cursor: pointer; }
        .git-status-indicator:hover { color: var(--text-bright); }
        .git-branch-icon-header { font-family: monospace; margin-right: 4px; font-size: 14px; }
        .git-dot { width: 8px; height: 8px; border-radius: 50%; margin-left: 6px; display: inline-block; }
        .git-dot.clean { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .git-dot.dirty { background: var(--warning); box-shadow: 0 0 6px var(--warning); }
        .git-dot.error { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
        .git-dot.loading { background: var(--text-dim); animation: pulse 1s infinite; }

        /* ‚îÄ‚îÄ Git Toast Notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .git-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 4.5s forwards;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .git-toast.error { background: var(--danger); color: white; }
        .git-toast.success { background: var(--success); color: white; }
        .git-toast.warning { background: var(--warning); color: #333; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }

        /* ‚îÄ‚îÄ Settings Dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .settings-btn {
            padding: 6px 10px;
            font-size: 16px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.15s;
        }
        .settings-btn:hover {
            color: var(--text-bright);
            background: var(--bg-card-hover);
            border-color: var(--border);
        }

        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-width: 220px;
            z-index: 100;
            display: none;
        }
        .settings-dropdown.show { display: block; }

        .settings-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text);
            transition: background 0.12s;
        }
        .settings-item:first-child { border-radius: var(--radius) var(--radius) 0 0; }
        .settings-item:last-child { border-radius: 0 0 var(--radius) var(--radius); }
        .settings-item:hover { background: var(--bg-card-hover); }
        .settings-item.danger { color: var(--danger); }
        .settings-item span { font-size: 16px; width: 20px; text-align: center; }

        .settings-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .btn {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 6px;
            background: var(--bg-card); color: var(--text); font-size: 13px;
            cursor: pointer; transition: all 0.15s ease; font-family: var(--font);
        }
        .btn:hover { background: var(--bg-card-hover); border-color: var(--border-active); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 600; }
        .btn.primary:hover { background: var(--accent-hover); }
        .btn.danger { border-color: var(--danger); color: var(--danger); }
        .btn.danger:hover { background: rgba(248,113,113,0.1); }
        .btn.success { background: var(--success); border-color: var(--success); color: #fff; font-weight: 600; }
        .btn.success:hover { background: #059669; }
        .btn.sm { padding: 5px 10px; font-size: 12px; }
        .btn.warning { border-color: var(--warning); color: var(--warning); }
        .btn.warning:hover { background: rgba(251,191,36,0.1); }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .main { display: grid; grid-template-columns: 320px 1fr; height: calc(100vh - 57px); }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .sidebar { border-right: 1px solid var(--border); overflow-y: auto; background: var(--bg-card); }
        .sidebar-section { padding: 16px; border-bottom: 1px solid var(--border); }
        .sidebar-section h3 {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-dim); margin-bottom: 12px;
        }

        .agent-list { list-style: none; }
        .agent-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; border-radius: 8px; cursor: pointer;
            transition: background 0.12s; margin-bottom: 2px;
        }
        .agent-item:hover { background: var(--bg-card-hover); }
        .agent-item.active { background: rgba(79,110,247,0.12); border-left: 3px solid var(--accent); }
        .agent-name { font-size: 14px; font-weight: 600; color: var(--text-bright); }
        .agent-role { font-size: 11px; color: var(--text-dim); }
        .agent-runtimes { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
        .agent-runtime {
            font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
            text-transform: uppercase; cursor: pointer; transition: all 0.15s ease;
            user-select: none; border: 1px solid transparent;
        }
        .agent-runtime.claude { background: rgba(52,211,153,0.08); color: rgba(52,211,153,0.35); }
        .agent-runtime.claude.selected { background: rgba(52,211,153,0.25); color: var(--success); border-color: var(--success); box-shadow: 0 0 6px rgba(52,211,153,0.3); }
        .agent-runtime.claude:hover { background: rgba(52,211,153,0.15); color: rgba(52,211,153,0.6); }
        .agent-runtime.claude.selected:hover { background: rgba(52,211,153,0.3); color: var(--success); }
        .agent-runtime.cursor { background: rgba(79,110,247,0.08); color: rgba(79,110,247,0.35); }
        .agent-runtime.cursor.selected { background: rgba(79,110,247,0.25); color: var(--accent); border-color: var(--accent); box-shadow: 0 0 6px rgba(79,110,247,0.3); }
        .agent-runtime.cursor:hover { background: rgba(79,110,247,0.15); color: rgba(79,110,247,0.6); }
        .agent-runtime.cursor.selected:hover { background: rgba(79,110,247,0.3); color: var(--accent); }

        /* (send-target-row removed ‚Äî runtime selection moved to agent sidebar badges) */

        /* ‚îÄ‚îÄ Content Area ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .content { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .content-header {
            padding: 16px 24px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; min-height: 60px;
        }
        .content-header h2 { font-size: 16px; font-weight: 600; color: var(--text-bright); }

        .chat-area {
            flex: 1; overflow-y: auto; padding: 20px 24px;
            display: flex; flex-direction: column; gap: 16px;
        }

        .message {
            max-width: 90%; padding: 14px 18px; border-radius: var(--radius);
            font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;
        }
        .message.user { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 2px; }
        .message.agent { align-self: flex-start; background: var(--bg-card); color: var(--text); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .message.system { align-self: center; background: rgba(79,110,247,0.08); color: var(--text-dim); font-size: 13px; padding: 8px 16px; border-radius: 20px; }
        .message.error { align-self: center; background: rgba(248,113,113,0.1); color: var(--danger); font-size: 13px; padding: 8px 16px; border-radius: 20px; }
        .message .meta { font-size: 11px; color: var(--text-dim); margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap; }
        .message.agent .meta { color: var(--text-dim); }
        .message.user .meta { color: rgba(255,255,255,0.7); justify-content: flex-end; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ */
        .chat-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-dim);
            gap: 12px;
        }
        .chat-loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .chat-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-dim);
            text-align: center;
        }

        .typing-indicator { display: none; align-self: flex-start; padding: 12px 18px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); gap: 4px; }
        .typing-indicator.show { display: flex; }
        .typing-indicator span { width: 6px; height: 6px; background: var(--text-dim); border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

        /* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .input-area { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-end; }
        .input-area textarea {
            flex: 1; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 8px; padding: 12px 14px; color: var(--text);
            font-family: var(--font); font-size: 14px; resize: none;
            min-height: 44px; max-height: 200px; outline: none; transition: border-color 0.15s;
        }
        .input-area textarea:focus { border-color: var(--accent); }
        .input-area textarea::placeholder { color: var(--text-dim); }

        /* ‚îÄ‚îÄ Welcome ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .welcome { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 16px; color: var(--text-dim); }
        .welcome h2 { font-size: 22px; color: var(--text-bright); }
        .welcome p { font-size: 14px; max-width: 500px; text-align: center; line-height: 1.6; }
        .welcome .actions { display: flex; gap: 10px; margin-top: 10px; }

        .empty-state { font-size: 13px; color: var(--text-dim); text-align: center; padding: 16px; }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px); display: none; align-items: center;
            justify-content: center; z-index: 1100;  /* –í—ã—à–µ project-picker (1000) */
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; width: 600px; max-height: 80vh;
            overflow-y: auto; box-shadow: var(--shadow);
        }
        .modal h3 { font-size: 16px; margin-bottom: 16px; color: var(--text-bright); }
        .modal pre {
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; padding: 12px; font-family: var(--mono);
            font-size: 12px; overflow-x: auto; margin-bottom: 16px; color: var(--text);
        }
        .modal .btn-group { display: flex; gap: 8px; justify-content: flex-end; }
        .modal label { display: block; font-size: 13px; color: var(--text-dim); margin-bottom: 4px; margin-top: 12px; }
        .modal input, .modal textarea, .modal select {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; padding: 8px 12px; color: var(--text);
            font-family: var(--font); font-size: 13px; outline: none;
        }
        .modal input:focus, .modal textarea:focus, .modal select:focus { border-color: var(--accent); }

        /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* ‚îÄ‚îÄ Theme Selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .theme-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .theme-select:hover { border-color: var(--border-active); }
        .theme-select:focus { outline: none; border-color: var(--accent); }

        /* ‚îÄ‚îÄ Project Picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .project-picker {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .project-picker.show { display: flex; }

        .project-picker-card {
            position: relative;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 32px;
            width: 100%;
            max-width: 480px;
            box-shadow: var(--shadow);
        }

        .project-picker-logo {
            text-align: center;
            margin-bottom: 8px;
        }
        .project-picker-logo h1 {
            font-size: 28px;
            color: var(--text-bright);
        }
        .project-picker-logo h1 span { color: var(--accent); }

        .project-picker h2 {
            text-align: center;
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 24px;
            font-weight: 400;
        }

        .project-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .project-item {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .project-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-active);
        }
        .project-item:last-child { margin-bottom: 0; }

        .project-item-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .project-item-info { flex: 1; min-width: 0; }

        .project-item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-item-path {
            font-size: 12px;
            color: var(--text-dim);
            font-family: var(--mono);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-item-time {
            font-size: 11px;
            color: var(--text-dim);
        }

        .project-item-remove {
            opacity: 0;
            color: var(--danger);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            transition: opacity 0.15s;
        }
        .project-item:hover .project-item-remove { opacity: 0.6; }
        .project-item-remove:hover { opacity: 1 !important; }

        .project-empty {
            text-align: center;
            padding: 32px;
            color: var(--text-dim);
        }
        .project-empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .project-empty.welcome-message h3 {
            color: var(--text-primary);
            margin: 0 0 0.5rem;
            font-size: 1.25rem;
        }
        .project-empty.welcome-message .project-empty-icon {
            opacity: 1;
        }

        .project-picker-actions {
            display: flex;
            gap: 8px;
        }
        .project-picker-actions .btn { flex: 1; justify-content: center; }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è project-picker */
        .project-picker-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            font-size: 24px;
            color: var(--text-dim);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.15s ease;
        }
        .project-picker-close:hover {
            color: var(--text);
            background: var(--bg-card-hover);
        }
        .project-picker-close:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .project-picker-close:disabled:hover {
            color: var(--text-dim);
            background: transparent;
        }

        @media (max-width: 768px) { .main { grid-template-columns: 1fr; } .sidebar { display: none; } }

        /* ‚îÄ‚îÄ Tasks Board ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .tasks-board-wrap { flex: 1; overflow-y: auto; padding: 20px 24px; }

        /* Sprint sections */
        .sprint-section {
            margin-bottom: 16px; border: 1px solid var(--border);
            border-radius: 12px; overflow: hidden; background: var(--bg-card);
        }
        .sprint-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 18px; cursor: pointer; user-select: none;
            transition: background 0.15s; gap: 12px;
        }
        .sprint-header:hover { background: var(--bg-card-hover); }
        .sprint-header-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        .sprint-toggle {
            font-size: 12px; color: var(--text-dim); transition: transform 0.2s;
            width: 20px; text-align: center; flex-shrink: 0;
        }
        .sprint-toggle.open { transform: rotate(90deg); }
        .sprint-id { font-size: 11px; color: var(--accent); font-family: var(--mono); font-weight: 600; flex-shrink: 0; }
        .sprint-title { font-size: 14px; font-weight: 600; color: var(--text-bright); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sprint-meta { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
        .sprint-badge {
            font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 600;
        }
        .sprint-badge.active { background: rgba(79,110,247,0.15); color: var(--accent); }
        .sprint-badge.done { background: rgba(52,211,153,0.15); color: var(--success); }
        .sprint-progress { font-size: 11px; color: var(--text-dim); }
        .sprint-body { display: none; padding: 0 18px 18px; }
        .sprint-body.open { display: block; }
        .sprint-desc { font-size: 12px; color: var(--text-dim); margin-bottom: 12px; line-height: 1.5; }

        .tasks-columns {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; min-height: 120px;
        }
        .tasks-column { background: var(--bg-input); border-radius: 10px; padding: 12px; min-width: 0; }
        .tasks-column-title {
            font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }
        .tasks-column-title .count {
            font-size: 10px; padding: 1px 7px; border-radius: 10px;
            background: rgba(79,110,247,0.15); color: var(--accent);
        }
        .col-–Ω–æ–≤–∞—è .tasks-column-title { border-bottom-color: var(--text-dim); color: var(--text-dim); }
        .col-–≤_—Ä–∞–±–æ—Ç–µ .tasks-column-title { border-bottom-color: var(--accent); color: var(--accent); }
        .col-–Ω–∞_–ø—Ä–æ–≤–µ—Ä–∫–µ .tasks-column-title { border-bottom-color: var(--warning); color: var(--warning); }
        .col-–≤—ã–ø–æ–ª–Ω–µ–Ω–∞ .tasks-column-title { border-bottom-color: var(--success); color: var(--success); }
        .col-–æ—Ç–º–µ–Ω–µ–Ω–∞ .tasks-column-title { border-bottom-color: var(--danger); color: var(--danger); }

        .task-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
            padding: 12px; margin-bottom: 8px; transition: border-color 0.15s;
        }
        .task-card:hover { border-color: var(--border-active); }
        .task-card-id { font-size: 11px; color: var(--text-dim); font-family: var(--mono); }
        .task-card-title { font-size: 13px; font-weight: 600; color: var(--text-bright); margin: 4px 0 8px; }
        .task-card-roles { font-size: 11px; color: var(--text-dim); line-height: 1.6; }
        .task-card-roles strong { color: var(--text); }
        .task-card-actions { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .task-card-result { margin-top: 8px; font-size: 11px; color: var(--text-dim); background: var(--bg-input); padding: 6px 8px; border-radius: 4px; max-height: 60px; overflow-y: auto; }
        .task-card-deps { margin-top: 6px; font-size: 11px; color: var(--purple); }
        .task-card-deps .dep-tag {
            display: inline-block; padding: 1px 6px; border-radius: 4px;
            background: rgba(167,139,250,0.1); margin-right: 4px; font-family: var(--mono);
        }
        .task-card-finalize { border-left: 3px solid var(--purple); }

        /* ‚îÄ‚îÄ Sprint Toolbar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .sprint-toolbar {
            display: flex; gap: 10px; align-items: center; margin-bottom: 14px;
            padding: 10px 14px; background: var(--bg-input); border-radius: 8px;
            border: 1px solid var(--border);
        }
        .sprint-toolbar .btn.auto-run {
            background: rgba(52,211,153,0.12); border-color: var(--success); color: var(--success);
            font-weight: 600; gap: 6px; display: inline-flex; align-items: center;
        }
        .sprint-toolbar .btn.auto-run:hover { background: rgba(52,211,153,0.22); }
        .sprint-toolbar .btn.auto-stop {
            background: rgba(248,113,113,0.12); border-color: var(--danger); color: var(--danger);
            font-weight: 600; gap: 6px; display: inline-flex; align-items: center;
        }
        .sprint-toolbar .btn.auto-stop:hover { background: rgba(248,113,113,0.22); }
        .auto-run-progress {
            display: inline-flex; align-items: center; gap: 8px; font-size: 12px;
            color: var(--accent); padding: 4px 12px; background: rgba(79,110,247,0.08);
            border-radius: 16px;
        }
        .auto-run-progress .spinner {
            width: 14px; height: 14px; border: 2px solid rgba(79,110,247,0.3);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .max-concurrent-inline {
            display: flex; align-items: center; gap: 6px; margin-left: auto;
        }
        .max-concurrent-inline label {
            font-size: 11px; color: var(--text-dim); white-space: nowrap;
        }
        .max-concurrent-inline input {
            width: 48px; padding: 4px 6px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 4px; color: var(--text); font-size: 13px; text-align: center;
            font-family: var(--mono);
        }
        .max-concurrent-inline input:focus { border-color: var(--accent); outline: none; }

        /* ‚îÄ‚îÄ Running task animation ‚îÄ‚îÄ‚îÄ‚îÄ */
        .task-card.running {
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(79,110,247,0.2);
            animation: taskRunningGlow 2s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        .task-card.running::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: taskRunningBar 2s linear infinite;
        }
        @keyframes taskRunningGlow {
            0%, 100% { box-shadow: 0 0 8px rgba(79,110,247,0.15); }
            50% { box-shadow: 0 0 20px rgba(79,110,247,0.35); }
        }
        @keyframes taskRunningBar {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .task-running-badge {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 11px; font-weight: 600; color: var(--accent);
            background: rgba(79,110,247,0.1); padding: 4px 10px;
            border-radius: 20px; margin-top: 8px;
        }
        .task-running-badge .spinner {
            width: 12px; height: 12px; border: 2px solid rgba(79,110,247,0.3);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .task-running-badge .elapsed {
            color: var(--text-dim); font-weight: 400;
        }

        .btn.running {
            background: rgba(79,110,247,0.15) !important;
            border-color: var(--accent) !important;
            color: var(--accent) !important;
            cursor: wait !important;
            position: relative;
            padding-left: 28px;
        }
        .btn.running::before {
            content: '';
            position: absolute; left: 10px; top: 50%;
            width: 12px; height: 12px;
            margin-top: -6px;
            border: 2px solid rgba(79,110,247,0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ‚îÄ‚îÄ Git Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .git-status-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .git-branch-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .git-branch-icon { font-size: 16px; }
        .git-branch-name {
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
        }
        .git-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .git-status-dot.clean { background: var(--success); box-shadow: 0 0 6px var(--success); }
        .git-status-dot.dirty { background: var(--warning); box-shadow: 0 0 6px var(--warning); }
        .git-changes {
            font-size: 11px;
            color: var(--text-dim);
            font-family: var(--mono);
        }
        .git-changes .staged { color: var(--success); }
        .git-changes .unstaged { color: var(--warning); }
        .git-changes .untracked { color: var(--text-dim); }
        .git-sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 6px;
        }
        .git-sync-status.synced { color: var(--success); }
        .git-sync-status.ahead { color: var(--accent); }
        .git-sync-status.behind { color: var(--warning); }
        .git-sync-status.diverged { color: var(--danger); }

        .git-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .git-actions .btn {
            flex: 1;
            min-width: 70px;
            justify-content: center;
            text-align: center;
        }

        .git-history {
            margin-top: 10px;
        }
        .git-history-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-dim);
            cursor: pointer;
            padding: 6px 0;
            user-select: none;
        }
        .git-history-toggle:hover { color: var(--text); }
        .git-history-toggle .arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }
        .git-history-toggle .arrow.open { transform: rotate(90deg); }
        .git-history-list {
            display: none;
            margin-top: 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        .git-history-list.open { display: block; }
        .git-commit-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
        }
        .git-commit-item:last-child { border-bottom: none; }
        .git-commit-hash {
            font-family: var(--mono);
            color: var(--accent);
            flex-shrink: 0;
        }
        .git-commit-msg {
            color: var(--text);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .git-commit-time {
            color: var(--text-dim);
            flex-shrink: 0;
        }

        .git-unavailable {
            text-align: center;
            padding: 16px;
            color: var(--text-dim);
            font-size: 12px;
        }
        .git-unavailable .icon { font-size: 24px; margin-bottom: 8px; opacity: 0.5; }

        /* Modal file list for commit */
        .commit-files-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-top: 8px;
        }
        .commit-file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }
        .commit-file-item:last-child { border-bottom: none; }
        .commit-file-item:hover { background: var(--bg-card-hover); }
        .commit-file-item input[type="checkbox"] {
            accent-color: var(--accent);
        }
        .commit-file-path {
            flex: 1;
            font-family: var(--mono);
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .commit-file-stats {
            font-family: var(--mono);
            font-size: 10px;
        }
        .commit-file-stats .add { color: var(--success); }
        .commit-file-stats .del { color: var(--danger); }

        /* Commit type selector */
        .commit-type-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .commit-type-row select,
        .commit-type-row input {
            flex: 1;
        }

    </style>
</head>
<body>

<!-- Project Picker -->
<div class="project-picker" id="projectPicker">
    <div class="project-picker-card">
        <button class="project-picker-close" id="projectPickerClose" onclick="tryCloseProjectPicker()" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        <div class="project-picker-logo">
            <h1><span>Tayfa</span></h1>
        </div>
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</h2>
        <div class="project-list" id="projectList">
            <div class="project-empty">
                <div class="project-empty-icon">üìÇ</div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
        <div class="project-picker-actions">
            <button class="btn primary" onclick="openFolderDialog()">üìÅ –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É</button>
            <button class="btn" onclick="openFolderManual()">‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –ø—É—Ç—å</button>
            <button class="btn" id="projectPickerCancel" onclick="tryCloseProjectPicker()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- Main App Container -->
<div id="mainApp">

<!-- Header -->
<div class="header">
    <div class="header-left">
        <h1><span>Tayfa</span></h1>
        <div class="current-project" id="currentProjectBadge" onclick="switchProject()" title="–°–º–µ–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç">
            <span class="project-icon">üìÅ</span>
            <span class="project-name" id="currentProjectName">‚Äî</span>
        </div>
    </div>
    <div class="status-bar">
        <div class="status-item">
            <span class="status-dot off" id="wslDot"></span>
            WSL: <span id="wslStatus">–≤—ã–∫–ª</span>
        </div>
        <div class="status-item">
            <span class="status-dot off" id="apiDot"></span>
            API: <span id="apiStatus">–≤—ã–∫–ª</span>
        </div>
        <div class="status-item git-status-indicator" id="gitStatusIndicator" title="Git —Å—Ç–∞—Ç—É—Å">
            <span class="git-branch-icon-header">‚éá</span>
            <span id="gitBranchHeader">‚Äî</span>
            <span class="git-dot" id="gitDotHeader"></span>
        </div>
        <div class="status-item" id="runningTasksIndicator" style="display:none; cursor:pointer;" onclick="showTasksBoard()">
            <span class="status-dot loading"></span>
            <span id="runningTasksCount">0</span> –∑–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ
        </div>
        <select id="themeSelect" onchange="changeTheme(this.value)" class="theme-select">
            <option value="dark">üåô Dark</option>
            <option value="light">‚òÄÔ∏è Light</option>
            <option value="blue">üåä Blue</option>
            <option value="girly">üíñ Girly</option>
        </select>
        <button class="btn success btn-start-server" id="btnStartServer" onclick="startServer()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
        <button class="btn danger" id="btnStopServer" onclick="stopServer()" style="display:none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn primary" onclick="ensureAgents()">–û–±–µ—Å–ø–µ—á–∏—Ç—å –∞–≥–µ–Ω—Ç–æ–≤</button>
        <button class="btn" onclick="refreshAll()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="settings-btn" onclick="toggleSettingsDropdown(event)" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        <!-- Settings Dropdown -->
        <div class="settings-dropdown" id="settingsDropdown">
            <div class="settings-item" onclick="switchProject()">
                <span>üìÅ</span> –°–º–µ–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
            </div>
            <div class="settings-item" onclick="showSettingsScreen()">
                <span>üé®</span> –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
            </div>
            <div class="settings-item" onclick="ensureAgents()">
                <span>üîÑ</span> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç–æ–≤
            </div>
            <div class="settings-divider"></div>
            <div class="settings-item danger" onclick="stopServer()">
                <span>‚ùå</span> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
            </div>
        </div>
    </div>
</div>

<!-- Main -->
<div class="main">
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Agents (renamed from "–ê–≥–µ–Ω—Ç—ã (—á–∞—Ç)" to "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏") -->
        <div class="sidebar-section">
            <h3>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3>
            <ul class="agent-list" id="agentList">
                <li class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
            </ul>
        </div>

        <!-- Navigation -->
        <div class="sidebar-section">
            <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <button class="btn primary" onclick="showTasksBoard()">–î–æ—Å–∫–∞ –∑–∞–¥–∞—á</button>
                <button class="btn" onclick="showOldTasksBoard()">–ó–∞–¥–∞—á–∏ (tasks.md)</button>
                <button class="btn" onclick="showSettingsScreen()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </div>

        <!-- Git Section -->
        <div class="sidebar-section" id="gitSection">
            <h3>Git</h3>
            <div id="gitStatusContainer">
                <div class="git-unavailable">
                    <div class="icon">‚è≥</div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="content" id="contentArea">
        <!-- Welcome Screen -->
        <div class="welcome" id="welcomeScreen">
            <h2>Tayfa Orchestrator</h2>
            <p>–ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ Claude Code.<br>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≥–µ–Ω—Ç–æ–≤ –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É.</p>
            <div class="actions">
                <button class="btn primary" onclick="showTasksBoard()">–î–æ—Å–∫–∞ –∑–∞–¥–∞—á</button>
                <button class="btn" onclick="startServer()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
                <button class="btn" onclick="ensureAgents()">–û–±–µ—Å–ø–µ—á–∏—Ç—å –∞–≥–µ–Ω—Ç–æ–≤</button>
            </div>
        </div>

        <!-- Tasks Board Screen (NEW ‚Äî kanban) -->
        <div id="tasksBoardScreen" style="display:none; flex-direction:column; height:100%; overflow:hidden;">
            <div class="content-header">
                <h2>–î–æ—Å–∫–∞ –∑–∞–¥–∞—á</h2>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div class="max-concurrent-inline">
                        <label>–ú–∞–∫—Å. –∑–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ:</label>
                        <input type="number" id="maxConcurrentInput" value="5" min="1" max="50">
                    </div>
                    <button class="btn sm primary" onclick="showCreateSprintModal()">+ –°–ø—Ä–∏–Ω—Ç</button>
                    <button class="btn sm" onclick="showCreateTaskModal()">+ –ó–∞–¥–∞—á–∞</button>
                    <button class="btn sm" onclick="showCreateBacklogModal()">+ –ë—ç–∫–ª–æ–≥</button>
                    <button class="btn sm" onclick="refreshTasksBoardNew()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
            <div class="tasks-board-wrap" id="tasksBoardWrap">
                <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- Old Tasks Board Screen (tasks.md) -->
        <div id="tasksScreen" style="display:none; flex-direction:column; height:100%; overflow:hidden;">
            <div class="content-header">
                <h2>–ó–∞–¥–∞—á–∏ (tasks.md)</h2>
                <button class="btn sm" onclick="refreshOldTasksBoard()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div style="flex:1; overflow-y:auto; padding:20px 24px;">
                <pre id="oldTasksBoardContent" style="white-space:pre-wrap; word-wrap:break-word; font-family:var(--mono); font-size:13px; color:var(--text); margin:0;"></pre>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chatScreen" style="display:none; flex-direction:column; height:100%;">
            <div class="content-header">
                <div><h2 id="chatAgentName">‚Äî</h2></div>
                <div style="display:flex; gap:8px;">
                    <button class="btn sm" onclick="clearChatHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                    <button class="btn sm" onclick="resetCurrentAgent()">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞–º—è—Ç—å</button>
                    <button class="btn sm danger" onclick="deleteCurrentAgent()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
            <div class="chat-area" id="chatArea"></div>
            <div class="typing-indicator" id="typingIndicator"><span></span><span></span><span></span></div>
            <div class="input-area">
                <textarea id="promptInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–≥–µ–Ω—Ç–∞..." rows="1"
                    onkeydown="handleKeyDown(event)" oninput="autoGrow(this)"></textarea>
                <button class="btn primary" id="btnSend" onclick="sendPrompt()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" style="display:none; flex-direction:column; height:100%;">
            <div class="content-header">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            </div>
            <div style="flex:1; overflow-y:auto; padding:24px;">
                <div style="max-width:600px;">
                    <!-- –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
                    <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:16px;">
                        <h3 style="font-size:14px; color:var(--text-bright); margin-bottom:12px;">üé® –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
                        <div style="display:flex; gap:12px; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 16px; background:var(--bg-input); border:1px solid var(--border); border-radius:8px; transition:all 0.15s;" class="theme-option" data-theme="dark">
                                <input type="radio" name="settingsTheme" value="dark" style="accent-color:var(--accent);">
                                <span>üåô –¢—ë–º–Ω–∞—è</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 16px; background:var(--bg-input); border:1px solid var(--border); border-radius:8px; transition:all 0.15s;" class="theme-option" data-theme="light">
                                <input type="radio" name="settingsTheme" value="light" style="accent-color:var(--accent);">
                                <span>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 16px; background:var(--bg-input); border:1px solid var(--border); border-radius:8px; transition:all 0.15s;" class="theme-option" data-theme="blue">
                                <input type="radio" name="settingsTheme" value="blue" style="accent-color:var(--accent);">
                                <span>üåä –°–∏–Ω—è—è</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 16px; background:var(--bg-input); border:1px solid var(--border); border-radius:8px; transition:all 0.15s;" class="theme-option" data-theme="girly">
                                <input type="radio" name="settingsTheme" value="girly" style="accent-color:var(--accent);">
                                <span>üíñ –†–æ–∑–æ–≤–∞—è</span>
                            </label>
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ -->
                    <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:16px;">
                        <h3 style="font-size:14px; color:var(--text-bright); margin-bottom:12px;">üñ•Ô∏è –°–µ—Ä–≤–µ—Ä</h3>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="color:var(--text-dim); font-size:13px;">–ü–æ—Ä—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</span>
                                <span id="settingsPort" style="font-family:var(--mono); color:var(--text); font-size:13px;">‚Äî</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="color:var(--text-dim); font-size:13px;">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                                <span id="settingsLanguage" style="color:var(--text); font-size:13px;">‚Äî</span>
                            </div>
                        </div>
                    </div>

                    <!-- –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ -->
                    <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:16px;">
                        <h3 style="font-size:14px; color:var(--text-bright); margin-bottom:12px;">üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</h3>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="settingsAutoOpen" style="accent-color:var(--accent); width:18px; height:18px;" onchange="saveSettingAutoOpen(this.checked)">
                            <div>
                                <div style="font-size:13px; color:var(--text);">–û—Ç–∫—Ä—ã–≤–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ</div>
                                <div style="font-size:11px; color:var(--text-dim);">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞</div>
                            </div>
                        </label>
                    </div>

                    <!-- –ó–∞–¥–∞—á–∏ -->
                    <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:16px;">
                        <h3 style="font-size:14px; color:var(--text-bright); margin-bottom:12px;">üìã –ó–∞–¥–∞—á–∏</h3>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="color:var(--text-dim); font-size:13px;">–ú–∞–∫—Å. –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á:</span>
                            <input type="number" id="settingsMaxTasks" min="1" max="50" value="5"
                                style="width:60px; padding:6px 10px; background:var(--bg-input); border:1px solid var(--border); border-radius:6px; color:var(--text); font-family:var(--mono); font-size:13px; text-align:center;"
                                onchange="saveSettingMaxTasks(this.value)">
                        </div>
                    </div>

                    <!-- Git / GitHub -->
                    <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:20px;">
                        <h3 style="font-size:14px; color:var(--text-bright); margin-bottom:12px;">üîß Git / GitHub</h3>
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div>
                                    <label style="display:block; color:var(--text-dim); font-size:12px; margin-bottom:4px;">–ò–º—è (user.name)</label>
                                    <input type="text" id="settingsGitUserName" placeholder="Your Name"
                                        style="width:100%; padding:8px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:13px;"
                                        onchange="saveSettingGit()">
                                </div>
                                <div>
                                    <label style="display:block; color:var(--text-dim); font-size:12px; margin-bottom:4px;">Email (user.email)</label>
                                    <input type="email" id="settingsGitUserEmail" placeholder="you@example.com"
                                        style="width:100%; padding:8px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:13px;"
                                        onchange="saveSettingGit()">
                                </div>
                            </div>
                            <div>
                                <label style="display:block; color:var(--text-dim); font-size:12px; margin-bottom:4px;">–í–µ—Ç–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                                <input type="text" id="settingsGitDefaultBranch" placeholder="main"
                                    style="width:100%; padding:8px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:13px;"
                                    onchange="saveSettingGit()">
                            </div>
                            <div>
                                <label style="display:block; color:var(--text-dim); font-size:12px; margin-bottom:4px;">GitHub Remote URL</label>
                                <input type="text" id="settingsGitRemoteUrl" placeholder="https://github.com/username/repo.git"
                                    style="width:100%; padding:8px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:6px; color:var(--text); font-family:var(--mono); font-size:12px;"
                                    onchange="saveSettingGit()">
                            </div>
                            <div>
                                <label style="display:block; color:var(--text-dim); font-size:12px; margin-bottom:4px;">GitHub Token (Personal Access Token)</label>
                                <input type="password" id="settingsGitHubToken" placeholder="ghp_xxxxxxxxxxxx"
                                    style="width:100%; padding:8px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:6px; color:var(--text); font-family:var(--mono); font-size:12px;"
                                    onchange="saveSettingGit()">
                                <div style="font-size:10px; color:var(--text-dim); margin-top:4px;">
                                    –¢–æ–∫–µ–Ω –Ω—É–∂–µ–Ω –¥–ª—è push/PR. –°–æ–∑–¥–∞–π—Ç–µ –Ω–∞ <a href="https://github.com/settings/tokens" target="_blank" style="color:var(--accent);">github.com/settings/tokens</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div><!-- /mainApp -->

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modalContent" onclick="event.stopPropagation()">
        <h3 id="modalTitle">‚Äî</h3>
        <div id="modalBody"></div>
        <div class="btn-group" id="modalActions" style="margin-top: 16px;"></div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let currentAgent = null;
let agents = {};
let employees = {};
let chatHistories = {};
let agentRuntimes = {};  // per-agent runtime: { agentName: 'claude' | 'cursor' }
let thinkingAgents = {};  // per-agent thinking state: { agentName: true }
let runningTasks = {};   // { taskId: { agent, role, runtime, started_at, elapsed_seconds } }
let runningTasksTimer = null;  // —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è elapsed
let sprintAutoRunState = {};   // { sprintId: { running: bool, cancelled: bool } }

const API_BASE = (typeof location !== 'undefined' && location.origin) ? location.origin : '';

// ‚îÄ‚îÄ Theme Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function applyTheme(themeName) {
    document.documentElement.setAttribute('data-theme', themeName);
}

async function changeTheme(newTheme) {
    try {
        const response = await api('POST', '/api/settings', { theme: newTheme });
        if (response.status === 'updated') {
            applyTheme(newTheme);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã: ' + error.message);
        // –í–µ—Ä–Ω—É—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        document.getElementById('themeSelect').value = currentTheme;
    }
}

async function loadSettings() {
    try {
        const settings = await api('GET', '/api/settings');

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
        const theme = settings.theme || 'dark';
        applyTheme(theme);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ header
        const themeSelect = document.getElementById('themeSelect');
        if (themeSelect) themeSelect.value = theme;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º maxConcurrentTasks –µ—Å–ª–∏ –µ—Å—Ç—å
        const maxInput = document.getElementById('maxConcurrentInput');
        if (maxInput && settings.maxConcurrentTasks) {
            maxInput.value = settings.maxConcurrentTasks;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        updateSettingsScreen(settings);

        return settings;
    } catch (error) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', error.message);
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        applyTheme('dark');
        return null;
    }
}

function updateSettingsScreen(settings) {
    if (!settings) return;

    // –¢–µ–º–∞ ‚Äî —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏
    const themeRadios = document.querySelectorAll('input[name="settingsTheme"]');
    themeRadios.forEach(radio => {
        radio.checked = radio.value === settings.theme;
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
        const label = radio.closest('.theme-option') || radio.parentElement;
        if (label) {
            label.style.borderColor = radio.checked ? 'var(--accent)' : 'var(--border)';
            label.style.background = radio.checked ? 'rgba(79,110,247,0.1)' : 'var(--bg-input)';
        }
    });

    // –ü–æ—Ä—Ç
    const portEl = document.getElementById('settingsPort');
    if (portEl) portEl.textContent = settings.port || '8008';

    // –Ø–∑—ã–∫
    const langEl = document.getElementById('settingsLanguage');
    if (langEl) langEl.textContent = settings.language === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English';

    // –ê–≤—Ç–æ–æ—Ç–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
    const autoOpenEl = document.getElementById('settingsAutoOpen');
    if (autoOpenEl) autoOpenEl.checked = settings.autoOpenBrowser !== false;

    // –ú–∞–∫—Å. –∑–∞–¥–∞—á
    const maxTasksEl = document.getElementById('settingsMaxTasks');
    if (maxTasksEl) maxTasksEl.value = settings.maxConcurrentTasks || 5;

    // Git –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const gitSettings = settings.git || {};
    const gitUserNameEl = document.getElementById('settingsGitUserName');
    if (gitUserNameEl) gitUserNameEl.value = gitSettings.userName || '';
    const gitUserEmailEl = document.getElementById('settingsGitUserEmail');
    if (gitUserEmailEl) gitUserEmailEl.value = gitSettings.userEmail || '';
    const gitDefaultBranchEl = document.getElementById('settingsGitDefaultBranch');
    if (gitDefaultBranchEl) gitDefaultBranchEl.value = gitSettings.defaultBranch || 'main';
    const gitRemoteUrlEl = document.getElementById('settingsGitRemoteUrl');
    if (gitRemoteUrlEl) gitRemoteUrlEl.value = gitSettings.remoteUrl || '';
    const gitHubTokenEl = document.getElementById('settingsGitHubToken');
    if (gitHubTokenEl) gitHubTokenEl.value = gitSettings.githubToken || '';
}

async function showSettingsScreen() {
    hideAllScreens();
    document.getElementById('settingsScreen').style.display = 'flex';

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const settings = await loadSettings();
    updateSettingsScreen(settings);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–æ–∫ —Ç–µ–º—ã
    document.querySelectorAll('input[name="settingsTheme"]').forEach(radio => {
        radio.onchange = async function() {
            await changeTheme(this.value);
            updateSettingsScreen(await api('GET', '/api/settings'));
        };
    });
}

async function saveSettingAutoOpen(value) {
    try {
        await api('POST', '/api/settings', { autoOpenBrowser: value });
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
        document.getElementById('settingsAutoOpen').checked = !value;
    }
}

async function saveSettingGit() {
    const userName = document.getElementById('settingsGitUserName').value.trim();
    const userEmail = document.getElementById('settingsGitUserEmail').value.trim();
    const defaultBranch = document.getElementById('settingsGitDefaultBranch').value.trim() || 'main';
    const remoteUrl = document.getElementById('settingsGitRemoteUrl').value.trim();
    const githubToken = document.getElementById('settingsGitHubToken').value.trim();
    try {
        await api('POST', '/api/settings', {
            git: { userName, userEmail, defaultBranch, remoteUrl, githubToken }
        });
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è Git –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message);
    }
}

async function saveSettingMaxTasks(value) {
    const numValue = parseInt(value);
    if (isNaN(numValue) || numValue < 1 || numValue > 50) {
        alert('–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 50');
        document.getElementById('settingsMaxTasks').value = 5;
        return;
    }
    try {
        await api('POST', '/api/settings', { maxConcurrentTasks: numValue });
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å input –Ω–∞ –¥–æ—Å–∫–µ –∑–∞–¥–∞—á
        const boardInput = document.getElementById('maxConcurrentInput');
        if (boardInput) boardInput.value = numValue;
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
}

// ‚îÄ‚îÄ Settings Dropdown Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleSettingsDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('settingsDropdown');
    dropdown.classList.toggle('show');
}

function closeSettingsDropdown() {
    const dropdown = document.getElementById('settingsDropdown');
    if (dropdown) dropdown.classList.remove('show');
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('settingsDropdown');
    const btn = document.querySelector('.settings-btn');
    if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.classList.remove('show');
    }
});

// ‚îÄ‚îÄ Current Project Badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateCurrentProjectBadge(project) {
    const nameEl = document.getElementById('currentProjectName');
    if (!nameEl) return;

    if (project && project.name) {
        nameEl.textContent = project.name;
    } else {
        nameEl.textContent = '‚Äî';
    }
}

// ‚îÄ‚îÄ Project Picker Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let projectsList = [];
let hasCurrentProject = false; // –§–ª–∞–≥: –µ—Å—Ç—å –ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç

async function showProjectPicker() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç
    try {
        const status = await api('GET', '/api/status');
        hasCurrentProject = !!status.has_project;
    } catch {
        hasCurrentProject = false;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è –ø—Ä–æ–µ–∫—Ç–∞
    const closeBtn = document.getElementById('projectPickerClose');
    const cancelBtn = document.getElementById('projectPickerCancel');

    if (closeBtn) {
        closeBtn.style.display = hasCurrentProject ? '' : 'none';
    }
    if (cancelBtn) {
        cancelBtn.style.display = hasCurrentProject ? '' : 'none';
    }

    document.getElementById('projectPicker').classList.add('show');
    document.getElementById('mainApp').style.display = 'none';
    loadProjectsList();
}

function hideProjectPicker() {
    document.getElementById('projectPicker').classList.remove('show');
    document.getElementById('mainApp').style.display = '';
}

// –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç—å project-picker (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç)
function tryCloseProjectPicker() {
    if (hasCurrentProject) {
        hideProjectPicker();
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ overlay (—Ñ–æ–Ω) project-picker
document.getElementById('projectPicker').addEventListener('click', function(e) {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ —Å–∞–º overlay (–Ω–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É) –∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç
    if (e.target === this && hasCurrentProject) {
        hideProjectPicker();
    }
});

let isNewUser = false;

async function loadProjectsList() {
    const container = document.getElementById('projectList');
    container.innerHTML = '<div class="project-empty"><div class="project-empty-icon">‚è≥</div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';

    try {
        const data = await api('GET', '/api/projects');
        console.log('[loadProjectsList] –û—Ç–≤–µ—Ç API:', data);
        projectsList = data.projects || [];
        isNewUser = data.is_new_user || false;
        renderProjectsList();
    } catch (error) {
        console.error('[loadProjectsList] –û—à–∏–±–∫–∞:', error);
        container.innerHTML = `<div class="project-empty"><div class="project-empty-icon">‚ùå</div><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${escapeHtml(error.message)}</p></div>`;
    }
}

function renderProjectsList() {
    const container = document.getElementById('projectList');

    if (projectsList.length === 0) {
        if (isNewUser) {
            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            container.innerHTML = `
                <div class="project-empty welcome-message">
                    <div class="project-empty-icon">üëã</div>
                    <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Tayfa!</h3>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 1rem; line-height: 1.5;">
                        Tayfa ‚Äî –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.<br>
                        AI-–∞–≥–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –∫–æ–º–∞–Ω–¥–∞: boss —Å—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á–∏,<br>
                        —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∏—à—É—Ç –∫–æ–¥, —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç.
                    </p>
                    <p style="color: var(--accent); font-weight: 500;">
                        –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É —Å –ø—Ä–æ–µ–∫—Ç–æ–º, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
                    </p>
                </div>`;
        } else {
            container.innerHTML = `
                <div class="project-empty">
                    <div class="project-empty-icon">üìÇ</div>
                    <p>–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É —Å –ø—Ä–æ–µ–∫—Ç–æ–º.</p>
                </div>`;
        }
        return;
    }

    const html = projectsList.map(project => `
        <div class="project-item" onclick="openProject('${escapeHtml(project.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'"))}')">
            <div class="project-item-icon">üìÅ</div>
            <div class="project-item-info">
                <div class="project-item-name">${escapeHtml(project.name)}</div>
                <div class="project-item-path">${escapeHtml(project.path)}</div>
                <div class="project-item-time">–û—Ç–∫—Ä—ã—Ç: ${formatLastOpened(project.last_opened)}</div>
            </div>
            <div class="project-item-remove" onclick="event.stopPropagation(); removeProject('${escapeHtml(project.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'"))}')" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞">√ó</div>
        </div>
    `).join('');

    container.innerHTML = html;
}

function formatLastOpened(isoDate) {
    if (!isoDate) return '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

    const date = new Date(isoDate);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        if (diffHours === 0) {
            const diffMins = Math.floor(diffMs / (1000 * 60));
            if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            return diffMins + ' –º–∏–Ω. –Ω–∞–∑–∞–¥';
        }
        return '—Å–µ–≥–æ–¥–Ω—è –≤ ' + date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
    } else if (diffDays === 1) {
        return '–≤—á–µ—Ä–∞';
    } else if (diffDays < 7) {
        return diffDays + ' –¥–Ω. –Ω–∞–∑–∞–¥';
    } else {
        return date.toLocaleDateString('ru');
    }
}

async function openProject(path) {
    const container = document.getElementById('projectList');
    const originalContent = container.innerHTML;
    container.innerHTML = '<div class="project-empty"><div class="project-empty-icon">‚è≥</div><p>–û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...</p></div>';

    console.log('[openProject] –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:', path);

    try {
        const result = await api('POST', '/api/projects/open', { path });
        console.log('[openProject] –û—Ç–≤–µ—Ç API:', result);

        if (result.status === 'opened' || result.status === 'initialized') {
            console.log('[openProject] –£—Å–ø–µ—à–Ω–æ! –°–∫—Ä—ã–≤–∞–µ–º picker...');
            hasCurrentProject = true; // –¢–µ–ø–µ—Ä—å –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç
            hideProjectPicker();

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∞–≥–µ–Ω—Ç–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å (–æ—à–∏–±–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ)
            try {
                await Promise.all([loadAgents(), checkStatus(), loadEmployees()]);
            } catch (loadError) {
                console.warn('[openProject] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):', loadError);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ header
            updateCurrentProjectBadge(result.project);

            // –ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ result.project.name –∏–ª–∏ fallback –Ω–∞ path
            const projectName = result.project?.name || path.split(/[\\\/]/).pop() || path;
            addSystemMessage(`–ü—Ä–æ–µ–∫—Ç "${projectName}" –æ—Ç–∫—Ä—ã—Ç`);
            console.log('[openProject] –ì–æ—Ç–æ–≤–æ!');
        } else {
            console.error('[openProject] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π status:', result.status);
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } catch (error) {
        console.error('[openProject] –û—à–∏–±–∫–∞:', error);
        container.innerHTML = originalContent;
        alert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message);
    }
}

async function removeProject(path) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–µ–¥–∞–≤–Ω–∏—Ö?\n\n–ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.')) return;

    try {
        await api('POST', '/api/projects/remove', { path });
        await loadProjectsList();
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

async function openFolderDialog() {
    // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π API –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
    try {
        const container = document.getElementById('projectList');
        const originalContent = container.innerHTML;
        container.innerHTML = '<div class="project-empty"><div class="project-empty-icon">üìÇ</div><p>–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏...</p></div>';

        const result = await api('GET', '/api/browse-folder');

        if (result.error) {
            container.innerHTML = originalContent;
            alert('–û—à–∏–±–∫–∞: ' + result.error);
            return;
        }

        if (result.cancelled || !result.path) {
            container.innerHTML = originalContent;
            return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—ã–±–æ—Ä
        }

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç
        await openProject(result.path);

    } catch (error) {
        console.error('[openFolderDialog] –û—à–∏–±–∫–∞:', error);
        // Fallback –Ω–∞ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
        openFolderManual();
    }
}

function openFolderManual(suggestedName = '') {
    const placeholder = suggestedName
        ? `–ù–∞–ø—Ä–∏–º–µ—Ä: C:\\Projects\\${suggestedName}`
        : '–ù–∞–ø—Ä–∏–º–µ—Ä: C:\\Projects\\MyApp –∏–ª–∏ /home/user/projects/app';

    const body = `
        <p style="font-size:13px; color:var(--text-dim); margin-bottom:12px;">
            –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞:
        </p>
        <input type="text" id="manualPathInput" placeholder="${placeholder}"
               style="width:100%; margin-bottom:8px;" autofocus>
        <p style="font-size:11px; color:var(--text-dim);">
            –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ.
            –í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞.
        </p>
    `;

    openModal('–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞', body,
        `<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
         <button class="btn primary" onclick="submitManualPath()">–û—Ç–∫—Ä—ã—Ç—å</button>`);

    // –§–æ–∫—É—Å –Ω–∞ input
    setTimeout(() => {
        const input = document.getElementById('manualPathInput');
        if (input) input.focus();
    }, 100);
}

async function submitManualPath() {
    const input = document.getElementById('manualPathInput');
    const path = input.value.trim();

    if (!path) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ');
        return;
    }

    console.log('[submitManualPath] –ü—É—Ç—å:', path);
    closeModal();
    await openProject(path);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ project-picker –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ header
function switchProject() {
    closeSettingsDropdown();
    showProjectPicker();
}

// ‚îÄ‚îÄ API Calls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function api(method, path, body = null) {
    const url = API_BASE ? (API_BASE + path) : path;
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    const resp = await fetch(url, opts);
    if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: resp.statusText }));
        let msg = err.detail || resp.statusText || '–û—à–∏–±–∫–∞ API';
        throw new Error(typeof msg === 'string' ? msg : JSON.stringify(msg));
    }
    return resp.json();
}

function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

// ‚îÄ‚îÄ Screens ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function hideAllScreens() {
    ['welcomeScreen','tasksBoardScreen','tasksScreen','chatScreen','settingsScreen'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    stopBoardAutoRefresh();
    stopRunningTasksTimer();
}

// ‚îÄ‚îÄ Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function checkStatus() {
    try {
        const s = await api('GET', '/api/status');
        updateStatusUI(s);
        return s;
    } catch {
        updateStatusUI({ wsl_running: false, api_running: false });
        return null;
    }
}

function updateStatusUI(s) {
    document.getElementById('wslDot').className = `status-dot ${s.wsl_running ? 'on' : 'off'}`;
    document.getElementById('apiDot').className = `status-dot ${s.api_running ? 'on' : 'off'}`;
    document.getElementById('wslStatus').textContent = s.wsl_running ? '—Ä–∞–±–æ—Ç–∞–µ—Ç' : '–≤—ã–∫–ª';
    document.getElementById('apiStatus').textContent = s.api_running ? '—Ä–∞–±–æ—Ç–∞–µ—Ç' : '–≤—ã–∫–ª';
    document.getElementById('btnStartServer').style.display = s.api_running ? 'none' : '';
    document.getElementById('btnStopServer').style.display = s.api_running ? '' : 'none';

    // –û–±–Ω–æ–≤–ª—è–µ–º badge —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    if (s.current_project) {
        updateCurrentProjectBadge(s.current_project);
    }
}

async function startServer() {
    const btn = document.getElementById('btnStartServer');
    btn.disabled = true; btn.textContent = '–ó–∞–ø—É—Å–∫–∞—é...';
    document.getElementById('wslDot').className = 'status-dot loading';
    try {
        await api('POST', '/api/start-server');
        await checkStatus(); await loadAgents();
    } catch (e) { addSystemMessage('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + e.message, true); }
    finally { btn.disabled = false; btn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä'; }
}

async function stopServer() {
    try { await api('POST', '/api/stop-server'); await checkStatus(); }
    catch (e) { addSystemMessage('–û—à–∏–±–∫–∞: ' + e.message, true); }
}

// ‚îÄ‚îÄ Employees (–¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadEmployees() {
    try {
        const data = await api('GET', '/api/employees');
        employees = data.employees || {};
    } catch {
        employees = {};
    }
}

// ‚îÄ‚îÄ Agents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadAgents() {
    const list = document.getElementById('agentList');
    try {
        agents = await api('GET', '/api/agents');
        if (!agents || typeof agents !== 'object' || Object.keys(agents).length === 0) {
            list.innerHTML = '<li class="empty-state">–ù–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤</li>';
            return;
        }
        list.innerHTML = '';
        for (const [name, config] of Object.entries(agents)) {
            const runtimes = config.runtimes || ['claude', 'cursor'];
            // Initialize default runtime selection (claude by default)
            if (!agentRuntimes[name]) {
                agentRuntimes[name] = runtimes.includes('claude') ? 'claude' : runtimes[0];
            }
            const selected = agentRuntimes[name];
            const runtimesHtml = runtimes.map(r =>
                `<span class="agent-runtime ${r} ${r === selected ? 'selected' : ''}" onclick="event.stopPropagation(); toggleAgentRuntime('${name}', '${r}')">${r}</span>`
            ).join('');
            const li = document.createElement('li');
            li.className = `agent-item ${name === currentAgent ? 'active' : ''}`;
            li.onclick = () => selectAgent(name);
            li.innerHTML = `
                <div style="flex:1; min-width:0;">
                    <div class="agent-name">${name}</div>
                    <div class="agent-role">${escapeHtml(config.role || '')}</div>
                    <div class="agent-runtimes" id="runtimes-${name}">${runtimesHtml}</div>
                </div>
            `;
            list.appendChild(li);
        }
    } catch {
        list.innerHTML = '<li class="empty-state">API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</li>';
    }
}

async function selectAgent(name) {
    currentAgent = name;
    hideAllScreens();
    document.getElementById('chatScreen').style.display = 'flex';
    document.getElementById('chatAgentName').textContent = name;

    // Ensure runtime is initialized
    if (!agentRuntimes[name]) {
        const config = agents[name] || {};
        const runtimes = config.runtimes || ['claude', 'cursor'];
        agentRuntimes[name] = runtimes.includes('claude') ? 'claude' : runtimes[0];
    }

    document.querySelectorAll('.agent-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.agent-item').forEach(el => {
        if (el.querySelector('.agent-name')?.textContent === name) el.classList.add('active');
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ API –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç –≤ –ø–∞–º—è—Ç–∏
    if (!chatHistories[name] || chatHistories[name].length === 0) {
        await loadChatHistory(name);
    } else {
        renderChat();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –¥—É–º–∞–µ—Ç –ª–∏ —ç—Ç–æ—Ç –∞–≥–µ–Ω—Ç
    updateTypingIndicator(name);

    document.getElementById('promptInput').focus();
}

function toggleAgentRuntime(agentName, runtime) {
    agentRuntimes[agentName] = runtime;
    // Update the runtime badges UI for this agent
    const container = document.getElementById('runtimes-' + agentName);
    if (container) {
        container.querySelectorAll('.agent-runtime').forEach(el => {
            el.classList.toggle('selected', el.textContent.trim() === runtime);
        });
    }
    // Also refresh task board if it's visible, to update tooltips
    if (document.getElementById('tasksBoardScreen').style.display !== 'none') {
        refreshTasksBoardNew();
    }
}

function getAgentRuntime(agentName) {
    return agentRuntimes[agentName] || 'claude';
}

async function resetCurrentAgent() {
    if (!currentAgent || !confirm(`–°–±—Ä–æ—Å–∏—Ç—å –ø–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞ "${currentAgent}"?`)) return;
    try {
        await api('POST', '/api/reset-agent', { name: currentAgent });
        addSystemMessage(`–ü–∞–º—è—Ç—å ${currentAgent} —Å–±—Ä–æ—à–µ–Ω–∞`);
        chatHistories[currentAgent] = [];
        renderChat();
    } catch (e) { addSystemMessage('–û—à–∏–±–∫–∞: ' + e.message, true); }
}

async function deleteCurrentAgent() {
    if (!currentAgent || !confirm(`–£–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ "${currentAgent}"?`)) return;
    try {
        await api('DELETE', `/api/agents/${currentAgent}`);
        addSystemMessage(`–ê–≥–µ–Ω—Ç ${currentAgent} —É–¥–∞–ª—ë–Ω`);
        currentAgent = null;
        hideAllScreens();
        document.getElementById('welcomeScreen').style.display = 'flex';
        await loadAgents();
    } catch (e) { addSystemMessage('–û—à–∏–±–∫–∞: ' + e.message, true); }
}

// ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —á–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ —á–∞—Å—ã:–º–∏–Ω—É—Ç—ã)
function formatChatTime(isoString) {
    if (!isoString) return '';
    const d = new Date(isoString);
    return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞
function buildChatMeta(msg) {
    const parts = [];
    if (msg.runtime) parts.push(msg.runtime);
    if (msg.cost_usd && msg.cost_usd > 0) parts.push(`$${msg.cost_usd.toFixed(4)}`);
    if (msg.duration_sec && msg.duration_sec > 0) parts.push(`${msg.duration_sec.toFixed(1)}s`);
    if (msg.task_id) parts.push(msg.task_id);
    if (msg.timestamp) parts.push(formatChatTime(msg.timestamp));
    return parts.join(' ¬∑ ');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –∏–∑ API
async function loadChatHistory(agentName) {
    const area = document.getElementById('chatArea');
    area.innerHTML = '<div class="chat-loading"><div class="chat-loading-spinner"></div><span>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</span></div>';

    try {
        const data = await api('GET', `/api/chat-history/${agentName}?limit=50`);
        chatHistories[agentName] = [];

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ API –≤ —Ñ–æ—Ä–º–∞—Ç —á–∞—Ç–∞
        for (const msg of data.messages || []) {
            // –ü—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (msg.prompt) {
                chatHistories[agentName].push({
                    type: 'user',
                    text: msg.prompt,
                    meta: formatChatTime(msg.timestamp)
                });
            }
            // –û—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞
            if (msg.result) {
                chatHistories[agentName].push({
                    type: msg.success === false ? 'error' : 'agent',
                    text: msg.result,
                    meta: buildChatMeta(msg)
                });
            }
        }

        renderChat();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
        if (chatHistories[agentName].length === 0) {
            area.innerHTML = '<div class="chat-empty"><p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p><p style="font-size:12px; margin-top:8px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É</p></div>';
        }
    } catch (e) {
        console.warn('[loadChatHistory] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e.message);
        // –ï—Å–ª–∏ API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
        chatHistories[agentName] = [];
        area.innerHTML = '<div class="chat-empty"><p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p></div>';
    }
}

// –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
async function clearChatHistory() {
    if (!currentAgent || !confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å —ç—Ç–∏–º –∞–≥–µ–Ω—Ç–æ–º?')) return;
    try {
        await api('POST', `/api/chat-history/${currentAgent}/clear`);
        chatHistories[currentAgent] = [];
        renderChat();
        addSystemMessage('–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –æ—á–∏—â–µ–Ω–∞');
    } catch (e) {
        addSystemMessage('–û—à–∏–±–∫–∞: ' + e.message, true);
    }
}

function renderChat() {
    const area = document.getElementById('chatArea');
    area.innerHTML = '';
    const history = chatHistories[currentAgent] || [];
    for (const msg of history) {
        const div = document.createElement('div');
        div.className = `message ${msg.type}`;
        div.textContent = msg.text;
        if (msg.meta) {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'meta';
            metaDiv.innerHTML = msg.meta;
            div.appendChild(metaDiv);
        }
        area.appendChild(div);
    }
    area.scrollTop = area.scrollHeight;
}

function addChatMessage(agent, type, text, meta = '') {
    if (!chatHistories[agent]) chatHistories[agent] = [];
    chatHistories[agent].push({ type, text, meta });
    if (agent === currentAgent) renderChat();
}

function addSystemMessage(text, isError = false) {
    if (currentAgent) addChatMessage(currentAgent, isError ? 'error' : 'system', text);
    console.log(`[${isError ? 'ERR' : 'SYS'}] ${text}`);
}

function updateTypingIndicator(agentName) {
    const indicator = document.getElementById('typingIndicator');
    indicator.classList.toggle('show', !!thinkingAgents[agentName]);
}

async function sendPrompt() {
    if (!currentAgent) return;
    const input = document.getElementById('promptInput');
    const text = input.value.trim();
    if (!text) return;
    input.value = ''; input.style.height = 'auto';
    addChatMessage(currentAgent, 'user', text);

    const agentForRequest = currentAgent;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    const btn = document.getElementById('btnSend');
    btn.disabled = true; btn.textContent = '...';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–¥—É–º–∞–µ—Ç" –¥–ª—è —ç—Ç–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    thinkingAgents[agentForRequest] = true;
    updateTypingIndicator(currentAgent);

    const runtime = getAgentRuntime(agentForRequest);
    try {
        if (runtime === 'cursor') {
            const result = await api('POST', '/api/send-prompt-cursor', { name: agentForRequest, prompt: text });
            if (result.success) {
                addChatMessage(agentForRequest, 'agent', result.result || '(–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)', result.stderr ? `Cursor CLI` : 'Cursor CLI');
            } else {
                addChatMessage(agentForRequest, 'error', (result.stderr || result.result || '–û—à–∏–±–∫–∞ Cursor CLI').trim());
            }
        } else {
            const result = await api('POST', '/api/send-prompt', { name: agentForRequest, prompt: text });
            const response = result.result || result.stdout || JSON.stringify(result);
            const meta = [];
            if (result.cost_usd) meta.push(`$${result.cost_usd.toFixed(4)}`);
            if (result.num_turns) meta.push(`${result.num_turns} turns`);
            addChatMessage(agentForRequest, 'agent', response, meta.join(' &middot; '));
        }
    } catch (e) {
        addChatMessage(agentForRequest, 'error', '–û—à–∏–±–∫–∞: ' + e.message);
    } finally {
        btn.disabled = false; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        // –£–±–∏—Ä–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–¥—É–º–∞–µ—Ç" –¥–ª—è —ç—Ç–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
        delete thinkingAgents[agentForRequest];
        updateTypingIndicator(currentAgent);
    }
}

function handleKeyDown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); } }
function autoGrow(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 200) + 'px'; }

// ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openModal(title, bodyHtml, actionsHtml) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = bodyHtml;
    document.getElementById('modalActions').innerHTML = actionsHtml;
    document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
}

document.getElementById('modalOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// ‚îÄ‚îÄ Tasks Board (NEW ‚Äî kanban with sprints) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const STATUS_LABELS = {
    '–Ω–æ–≤–∞—è': '–ù–æ–≤–∞—è',
    '–≤_—Ä–∞–±–æ—Ç–µ': '–í —Ä–∞–±–æ—Ç–µ',
    '–Ω–∞_–ø—Ä–æ–≤–µ—Ä–∫–µ': '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
    '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞': '–í—ã–ø–æ–ª–Ω–µ–Ω–∞',
    '–æ—Ç–º–µ–Ω–µ–Ω–∞': '–û—Ç–º–µ–Ω–µ–Ω–∞',
};

const STATUS_NEXT_ROLE = {
    '–Ω–æ–≤–∞—è': { role: 'customer', label: '–ó–∞–∫–∞–∑—á–∏–∫ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ—Ç', btnClass: 'primary' },
    '–≤_—Ä–∞–±–æ—Ç–µ': { role: 'developer', label: '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç', btnClass: 'primary' },
    '–Ω–∞_–ø—Ä–æ–≤–µ—Ä–∫–µ': { role: 'tester', label: '–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç', btnClass: 'warning' },
};

let boardAutoRefreshTimer = null;
let expandedSprints = {};  // { sprintId: true/false } ‚Äî –∫–∞–∫–∏–µ —Å–ø—Ä–∏–Ω—Ç—ã —Ä–∞—Å–∫—Ä—ã—Ç—ã
let allSprints = [];       // –∫—ç—à —Å–ø—Ä–∏–Ω—Ç–æ–≤
let allTasks = [];         // –∫—ç—à –∑–∞–¥–∞—á

function showTasksBoard() {
    hideAllScreens();
    document.getElementById('tasksBoardScreen').style.display = 'flex';
    refreshTasksBoardNew();
    startBoardAutoRefresh();
}

function startBoardAutoRefresh() {
    stopBoardAutoRefresh();
    boardAutoRefreshTimer = setInterval(() => {
        if (document.getElementById('tasksBoardScreen').style.display !== 'none') {
            fetchRunningTasks().then(() => {
                if (Object.keys(runningTasks).length > 0) {
                    refreshTasksBoardNew();
                }
            });
        } else {
            stopBoardAutoRefresh();
        }
    }, 5000);
}

function stopBoardAutoRefresh() {
    if (boardAutoRefreshTimer) { clearInterval(boardAutoRefreshTimer); boardAutoRefreshTimer = null; }
}

async function fetchRunningTasks() {
    try {
        const data = await api('GET', '/api/running-tasks');
        const serverRunning = data.running || {};
        for (const tid of Object.keys(runningTasks)) {
            if (!serverRunning[tid] && runningTasks[tid]._local) {
                serverRunning[tid] = runningTasks[tid];
            }
        }
        runningTasks = serverRunning;
        updateRunningTasksIndicator();
    } catch { }
}

function startRunningTasksTimer() {
    stopRunningTasksTimer();
    runningTasksTimer = setInterval(() => {
        const badges = document.querySelectorAll('.task-running-badge .elapsed');
        badges.forEach(el => {
            const startedAt = parseFloat(el.dataset.startedAt);
            if (startedAt) {
                const elapsed = Math.round(Date.now() / 1000 - startedAt);
                el.textContent = formatElapsed(elapsed);
            }
        });
    }, 1000);
}

function stopRunningTasksTimer() {
    if (runningTasksTimer) { clearInterval(runningTasksTimer); runningTasksTimer = null; }
}

function formatElapsed(seconds) {
    if (seconds < 60) return `${seconds}—Å`;
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}–º ${s}—Å`;
}

function toggleSprint(sprintId) {
    expandedSprints[sprintId] = !expandedSprints[sprintId];
    const body = document.getElementById('sprint-body-' + sprintId);
    const toggle = document.getElementById('sprint-toggle-' + sprintId);
    if (body) body.classList.toggle('open', expandedSprints[sprintId]);
    if (toggle) toggle.classList.toggle('open', expandedSprints[sprintId]);
}

async function refreshTasksBoardNew() {
    const wrap = document.getElementById('tasksBoardWrap');
    wrap.innerHTML = '<div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
        const [tasksData, sprintsData] = await Promise.all([
            api('GET', '/api/tasks-list'),
            api('GET', '/api/sprints'),
            fetchRunningTasks(),
        ]);
        allTasks = tasksData.tasks || [];
        allSprints = sprintsData.sprints || [];

        if (allTasks.length === 0 && allSprints.length === 0) {
            wrap.innerHTML = `<div class="empty-state" style="padding:40px;">
                <p style="margin-bottom:16px;">–ó–∞–¥–∞—á –∏ —Å–ø—Ä–∏–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ø—Ä–∏–Ω—Ç.</p>
                <button class="btn primary" onclick="showCreateSprintModal()">+ –°–æ–∑–¥–∞—Ç—å —Å–ø—Ä–∏–Ω—Ç</button>
            </div>`;
            stopRunningTasksTimer();
            return;
        }

        const hasRunning = Object.keys(runningTasks).length > 0;

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ —Å–ø—Ä–∏–Ω—Ç–∞–º
        const tasksBySprint = {};
        const orphanTasks = [];
        for (const t of allTasks) {
            const sid = t.sprint_id || '';
            if (sid) {
                if (!tasksBySprint[sid]) tasksBySprint[sid] = [];
                tasksBySprint[sid].push(t);
            } else {
                orphanTasks.push(t);
            }
        }

        let html = '';

        // –°–ø—Ä–∏–Ω—Ç—ã: –ø–µ—Ä–≤—ã–µ (—Å—Ç–∞—Ä—ã–µ) –≤–Ω–∏–∑—É -> —Ä–µ–Ω–¥–µ—Ä–∏–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
        // –ù–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ "–ø–µ—Ä–≤—ã–µ –≤–Ω–∏–∑—É" => —Ä–µ–Ω–¥–µ—Ä–∏–º –≤ –ø—Ä—è–º–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É),
        // –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ—Ç flex-direction: column-reverse
        // –ù–µ—Ç, –ø—Ä–æ—â–µ: "–ø–µ—Ä–≤—ã–µ –≤–Ω–∏–∑—É" –∑–Ω–∞—á–∏—Ç —Å–∞–º—ã–µ —Ä–∞–Ω–Ω–∏–µ —Å–ø—Ä–∏–Ω—Ç—ã –≤–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞.
        // –¢.–µ. —Ä–µ–Ω–¥–µ—Ä–∏–º sprints –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (newest first, oldest last at bottom)
        // –ù–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ oldest –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–Ω–∏–∑—É, newest —Å–≤–µ—Ä—Ö—É.
        // –ü–æ—Ä—è–¥–æ–∫ –≤ –º–∞—Å—Å–∏–≤–µ: sprints[0] = oldest, sprints[N-1] = newest
        // –†–µ–Ω–¥–µ—Ä–∏–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ: newest —Å–≤–µ—Ä—Ö—É.
        const sortedSprints = [...allSprints].reverse();

        for (const sprint of sortedSprints) {
            const sprintTasks = tasksBySprint[sprint.id] || [];
            const isOpen = expandedSprints[sprint.id] || false;
            // –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á–∏ (–≤–∫–ª—é—á–∞—è —Ñ–∏–Ω–∞–ª—å–Ω—É—é)
            const doneCount = sprintTasks.filter(t => t.status === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞').length;
            const totalCount = sprintTasks.length;
            // –°–ø—Ä–∏–Ω—Ç –∑–∞–≤–µ—Ä—à—ë–Ω, –µ—Å–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
            const finalizeTask = sprintTasks.find(t => t.is_finalize);
            const isSprintDone = sprint.status === '–∑–∞–≤–µ—Ä—à—ë–Ω' || (finalizeTask && finalizeTask.status === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
            const statusBadge = isSprintDone
                ? '<span class="sprint-badge done">–∑–∞–≤–µ—Ä—à—ë–Ω</span>'
                : '<span class="sprint-badge active">–∞–∫—Ç–∏–≤–Ω—ã–π</span>';

            html += `<div class="sprint-section">
                <div class="sprint-header" onclick="toggleSprint('${sprint.id}')">
                    <div class="sprint-header-left">
                        <span class="sprint-toggle${isOpen ? ' open' : ''}" id="sprint-toggle-${sprint.id}">&#9654;</span>
                        <span class="sprint-id">${escapeHtml(sprint.id)}</span>
                        <span class="sprint-title">${escapeHtml(sprint.title)}</span>
                    </div>
                    <div class="sprint-meta">
                        ${statusBadge}
                        <span class="sprint-progress">${doneCount}/${totalCount} –∑–∞–¥–∞—á</span>
                    </div>
                </div>
                <div class="sprint-body${isOpen ? ' open' : ''}" id="sprint-body-${sprint.id}">
                    ${sprint.description ? `<div class="sprint-desc">${escapeHtml(sprint.description)}</div>` : ''}
                    ${renderSprintToolbar(sprint, sprintTasks)}
                    ${renderKanbanBoard(sprintTasks)}
                </div>
            </div>`;
        }

        // –ó–∞–¥–∞—á–∏ –±–µ–∑ —Å–ø—Ä–∏–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (orphanTasks.length > 0) {
            const isOpen = expandedSprints['_orphan'] || false;
            html += `<div class="sprint-section" style="border-color: var(--text-dim);">
                <div class="sprint-header" onclick="toggleSprint('_orphan')">
                    <div class="sprint-header-left">
                        <span class="sprint-toggle${isOpen ? ' open' : ''}" id="sprint-toggle-_orphan">&#9654;</span>
                        <span class="sprint-id" style="color:var(--text-dim);">‚Äî</span>
                        <span class="sprint-title" style="color:var(--text-dim);">–ó–∞–¥–∞—á–∏ –±–µ–∑ —Å–ø—Ä–∏–Ω—Ç–∞</span>
                    </div>
                    <div class="sprint-meta">
                        <span class="sprint-progress">${orphanTasks.length} –∑–∞–¥–∞—á</span>
                    </div>
                </div>
                <div class="sprint-body${isOpen ? ' open' : ''}" id="sprint-body-_orphan">
                    ${renderKanbanBoard(orphanTasks)}
                </div>
            </div>`;
        }

        wrap.innerHTML = html;

        if (hasRunning) {
            startRunningTasksTimer();
        } else {
            stopRunningTasksTimer();
        }
    } catch (e) {
        wrap.innerHTML = '<div class="empty-state" style="color:var(--danger);">–û—à–∏–±–∫–∞: ' + escapeHtml(e.message) + '</div>';
    }
}

function renderKanbanBoard(tasks) {
    const statuses = ['–Ω–æ–≤–∞—è', '–≤_—Ä–∞–±–æ—Ç–µ', '–Ω–∞_–ø—Ä–æ–≤–µ—Ä–∫–µ', '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞', '–æ—Ç–º–µ–Ω–µ–Ω–∞'];
    const grouped = {};
    statuses.forEach(s => grouped[s] = []);
    tasks.forEach(t => {
        if (grouped[t.status]) grouped[t.status].push(t);
        else grouped['–Ω–æ–≤–∞—è'].push(t);
    });

    let html = '<div class="tasks-columns">';
    for (const status of statuses) {
        const col = grouped[status];
        html += `<div class="tasks-column col-${status}">
            <div class="tasks-column-title">${STATUS_LABELS[status]} <span class="count">${col.length}</span></div>`;
        for (const t of col) {
            html += renderTaskCard(t);
        }
        html += '</div>';
    }
    html += '</div>';
    return html;
}

function renderTaskCard(t) {
    const isRunning = !!runningTasks[t.id];
    const runInfo = runningTasks[t.id];
    const next = STATUS_NEXT_ROLE[t.status];
    let actionsHtml = '';
    const isFinalize = t.is_finalize || false;

    if (isRunning) {
        actionsHtml += `<button class="btn sm running" disabled title="–ê–≥–µ–Ω—Ç ${escapeHtml(runInfo.agent || '?')} —Ä–∞–±–æ—Ç–∞–µ—Ç...">${escapeHtml(runInfo.agent || '–ê–≥–µ–Ω—Ç')} –¥—É–º–∞–µ—Ç...</button>`;
    } else if (next) {
        const agentName = t[next.role] || '‚Äî';
        const agentRuntime = getAgentRuntime(agentName);
        const runtimeLabel = agentRuntime === 'cursor' ? '–ß–µ—Ä–µ–∑ Cursor CLI' : '–ß–µ—Ä–µ–∑ Claude API';
        actionsHtml += `<button class="btn sm ${next.btnClass}" onclick="triggerTask('${t.id}','${agentRuntime}')" title="${runtimeLabel}">${escapeHtml(next.label)} (${escapeHtml(agentName)})</button>`;
    }

    if (!isRunning && t.status !== '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' && t.status !== '–æ—Ç–º–µ–Ω–µ–Ω–∞') {
        actionsHtml += `<button class="btn sm danger" onclick="cancelTask('${t.id}')" title="–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É">–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
    }
    if (!isRunning && t.status === '–Ω–∞_–ø—Ä–æ–≤–µ—Ä–∫–µ') {
        actionsHtml += `<button class="btn sm" onclick="rejectTask('${t.id}')" title="–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É">–í–µ—Ä–Ω—É—Ç—å</button>`;
    }

    let resultHtml = '';
    if (t.result) {
        resultHtml = `<div class="task-card-result">${escapeHtml(t.result.slice(0, 200))}${t.result.length > 200 ? '...' : ''}</div>`;
    }

    // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    let depsHtml = '';
    const deps = t.depends_on || [];
    if (deps.length > 0) {
        const depTags = deps.map(depId => {
            const depTask = allTasks.find(x => x.id === depId);
            const depStatus = depTask ? depTask.status : '?';
            const depDone = depStatus === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞';
            const depColor = depDone ? 'color:var(--success)' : 'color:var(--warning)';
            const icon = depDone ? '&#10003;' : '&#9679;';
            return `<span class="dep-tag" style="${depColor}" title="${depId}: ${depStatus}">${icon} ${depId}</span>`;
        }).join('');
        depsHtml = `<div class="task-card-deps">–ó–∞–≤–∏—Å–∏—Ç –æ—Ç: ${depTags}</div>`;
    }

    // Running badge
    let runningBadgeHtml = '';
    if (isRunning) {
        const elapsed = runInfo.elapsed_seconds || 0;
        const startedAt = runInfo.started_at || (Date.now() / 1000 - elapsed);
        const runtimeIcon = runInfo.runtime === 'cursor' ? 'Cursor' : 'Claude';
        runningBadgeHtml = `<div class="task-running-badge">
            <div class="spinner"></div>
            <span>${escapeHtml(runInfo.agent || '?')} ¬∑ ${escapeHtml(runInfo.role || '')} ¬∑ ${runtimeIcon}</span>
            <span class="elapsed" data-started-at="${startedAt}">${formatElapsed(elapsed)}</span>
        </div>`;
    }

    return `<div class="task-card${isRunning ? ' running' : ''}${isFinalize ? ' task-card-finalize' : ''}">
        <div class="task-card-id">${escapeHtml(t.id)}${isFinalize ? ' ¬∑ –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø' : ''} ¬∑ ${escapeHtml((t.updated_at || t.created_at || '').replace('T',' ').slice(0,16))}</div>
        <div class="task-card-title">${escapeHtml(t.title)}</div>
        ${t.description && !isFinalize ? `<div style="font-size:12px;color:var(--text-dim);margin-bottom:6px;">${escapeHtml(t.description.slice(0, 120))}${t.description.length > 120 ? '...' : ''}</div>` : ''}
        <div class="task-card-roles">
            <strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> ${escapeHtml(t.customer || '‚Äî')} &nbsp;
            <strong>–†–∞–∑—Ä–∞–±:</strong> ${escapeHtml(t.developer || '‚Äî')} &nbsp;
            <strong>–¢–µ—Å—Ç–µ—Ä:</strong> ${escapeHtml(t.tester || '‚Äî')}
        </div>
        ${depsHtml}
        ${resultHtml}
        ${runningBadgeHtml}
        <div class="task-card-actions">${actionsHtml}</div>
    </div>`;
}

async function triggerTask(taskId, runtime) {
    if (runningTasks[taskId]) return;

    const btn = event.target;
    runningTasks[taskId] = {
        agent: btn.textContent.match(/\(([^)]+)\)/)?.[1] || '?',
        role: '',
        runtime: runtime,
        started_at: Date.now() / 1000,
        elapsed_seconds: 0,
        _local: true,
    };
    updateRunningTasksIndicator();
    await refreshTasksBoardNew();

    try {
        const result = await api('POST', `/api/tasks-list/${taskId}/trigger`, { runtime });
        if (result.agent) {
            addChatMessage(result.agent, 'system', `–ó–∞–¥–∞—á–∞ ${taskId}: ${result.role}`);
            if (result.result) {
                addChatMessage(result.agent, 'agent', result.result);
            }
        }
    } catch (e) {
        console.error('triggerTask error:', e.message);
        if (!e.message.includes('—É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è')) {
            alert('–û—à–∏–±–∫–∞: ' + e.message);
        }
    } finally {
        delete runningTasks[taskId];
        if (document.getElementById('tasksBoardScreen').style.display !== 'none') {
            await refreshTasksBoardNew();
        }
    }
}

async function cancelTask(taskId) {
    if (!confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É ${taskId}?`)) return;
    try {
        await api('PUT', `/api/tasks-list/${taskId}/status`, { status: '–æ—Ç–º–µ–Ω–µ–Ω–∞' });
        await refreshTasksBoardNew();
    } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
}

async function rejectTask(taskId) {
    try {
        await api('PUT', `/api/tasks-list/${taskId}/status`, { status: '–≤_—Ä–∞–±–æ—Ç–µ' });
        await refreshTasksBoardNew();
    } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
}

// ‚îÄ‚îÄ Sprint Auto-Run ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderSprintToolbar(sprint, sprintTasks) {
    // Only show toolbar for active sprints that have tasks
    const nonFinalTasks = sprintTasks.filter(t => !t.is_finalize);
    if (nonFinalTasks.length === 0) return '';

    const isAutoRunning = sprintAutoRunState[sprint.id]?.running;
    const doneCount = sprintTasks.filter(t => t.status === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' || t.status === '–æ—Ç–º–µ–Ω–µ–Ω–∞').length;
    const totalCount = sprintTasks.length;
    const allDone = sprintTasks.every(t => t.status === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' || t.status === '–æ—Ç–º–µ–Ω–µ–Ω–∞');

    let btnHtml = '';
    if (allDone && sprint.status === '–∑–∞–≤–µ—Ä—à—ë–Ω') {
        // –°–ø—Ä–∏–Ω—Ç —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω –∏ —Ä–µ–ª–∏–∑ –≤—ã–ø—É—â–µ–Ω
        btnHtml = `<span style="font-size:12px; color:var(--success); font-weight:600;">‚úì –†–µ–ª–∏–∑ ${sprint.version || ''} –≤—ã–ø—É—â–µ–Ω</span>`;
    } else if (allDone) {
        // –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ–ª–∏–∑–∞
        btnHtml = `<button class="btn sm success" onclick="event.stopPropagation(); showReleaseModal('${sprint.id}')">üöÄ –í—ã–ø—É—Å—Ç–∏—Ç—å —Ä–µ–ª–∏–∑</button>`;
    } else if (isAutoRunning) {
        btnHtml = `<button class="btn sm auto-stop" onclick="event.stopPropagation(); stopSprintAutoRun('${sprint.id}')">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>`;
        btnHtml += `<div class="auto-run-progress"><div class="spinner"></div><span>–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫: ${doneCount}/${totalCount} –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span></div>`;
    } else {
        btnHtml = `<button class="btn sm auto-run" onclick="event.stopPropagation(); runAllSprintTasks('${sprint.id}')">‚ñ∂ –°–¥–µ–ª–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å–ø—Ä–∏–Ω—Ç–∞</button>`;
    }

    return `<div class="sprint-toolbar">${btnHtml}</div>`;
}

// ‚îÄ‚îÄ Release Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function showReleaseModal(sprintId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingBody = `
        <div style="text-align:center; padding:20px;">
            <div class="spinner" style="margin:0 auto 16px;"></div>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ä–µ–ª–∏–∑—É...</p>
        </div>
    `;
    openModal('üöÄ –í—ã–ø—É—Å—Ç–∏—Ç—å —Ä–µ–ª–∏–∑', loadingBody, '');

    try {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ä–µ–ª–∏–∑—É
        const releaseInfo = await api('GET', `/api/sprints/${sprintId}/release-ready`);

        if (!releaseInfo.ready) {
            const pendingIds = (releaseInfo.pending_tasks || []).map(t => t.id || t).join(', ');
            closeModal();
            alert('–ù–µ –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã: ' + pendingIds);
            return;
        }

        const sprint = allSprints.find(s => s.id === sprintId);
        const sprintTitle = sprint?.title || sprintId;
        const nextVersion = releaseInfo.next_version || 'v0.1.0';
        const doneCount = releaseInfo.done_count || '?';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–ª–∏–∑–∞
        const body = `
            <div style="display:flex; flex-direction:column; gap:16px;">
                <div>
                    <label style="font-size:12px; color:var(--text-dim);">–°–ø—Ä–∏–Ω—Ç</label>
                    <p style="margin:4px 0; font-weight:600;">${escapeHtml(sprintId)} ¬´${escapeHtml(sprintTitle)}¬ª</p>
                </div>
                <div>
                    <label style="font-size:12px; color:var(--text-dim);">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</label>
                    <p style="margin:4px 0;">${doneCount}</p>
                </div>
                <div>
                    <label style="font-size:12px; color:var(--text-dim);">–í–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞</label>
                    <input type="text" id="releaseVersion" value="${escapeHtml(nextVersion)}" style="width:100%; margin-top:4px;">
                </div>
                <p style="font-size:12px; color:var(--text-dim); margin:0;">
                    –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∫–æ–º–º–∏—Ç —Å–æ –≤—Å–µ–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏, —Ç–µ–≥ —Å –≤–µ—Ä—Å–∏–µ–π –∏ push –≤ GitHub.
                </p>
            </div>
        `;

        openModal('üöÄ –í—ã–ø—É—Å—Ç–∏—Ç—å —Ä–µ–ª–∏–∑', body,
            `<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
             <button class="btn success" onclick="executeRelease('${sprintId}')">–í—ã–ø—É—Å—Ç–∏—Ç—å</button>`);
    } catch (e) {
        closeModal();
        alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ' + e.message);
    }
}

async function executeRelease(sprintId) {
    const versionInput = document.getElementById('releaseVersion');
    const version = versionInput?.value?.trim();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('modalBody').innerHTML = `
        <div style="text-align:center; padding:20px;">
            <div class="spinner" style="margin:0 auto 16px;"></div>
            <p>–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞...</p>
            <p style="font-size:12px; color:var(--text-dim); margin-top:8px;">–ö–æ–º–º–∏—Ç, —Ç–µ–≥, push –≤ GitHub...</p>
        </div>
    `;
    document.getElementById('modalActions').innerHTML = '';

    try {
        const result = await api('POST', '/api/git/release', {
            sprint_id: sprintId,
            version: version || undefined
        });

        closeModal();

        if (result.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            const successMsg = `üöÄ –†–µ–ª–∏–∑ ${result.version} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!\n–ö–æ–º–º–∏—Ç: ${result.commit || 'created'}\n–¢–µ–≥: ${result.tag_created ? '—Å–æ–∑–¥–∞–Ω' : '–Ω–µ—Ç'}`;
            alert(successMsg);

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            await Promise.all([
                refreshTasksBoardNew(),
                loadSprints(),
                loadGitStatus()
            ]);
        } else {
            alert('–û—à–∏–±–∫–∞ —Ä–µ–ª–∏–∑–∞: ' + (result.error || result.message || 'Unknown error'));
        }
    } catch (e) {
        closeModal();
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

async function triggerTaskAutoRun(taskId, runtime) {
    if (runningTasks[taskId]) return;

    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    const next = STATUS_NEXT_ROLE[task.status];
    if (!next) return;
    const agentName = task[next.role] || '?';

    runningTasks[taskId] = {
        agent: agentName,
        role: next.label || '',
        runtime: runtime,
        started_at: Date.now() / 1000,
        elapsed_seconds: 0,
        _local: true,
    };
    updateRunningTasksIndicator();

    try {
        const result = await api('POST', `/api/tasks-list/${taskId}/trigger`, { runtime });
        if (result.agent && result.result) {
            addChatMessage(result.agent, 'system', `–ó–∞–¥–∞—á–∞ ${taskId}: ${result.role}`);
            addChatMessage(result.agent, 'agent', result.result);
        }
    } catch (e) {
        console.error(`[AutoRun] triggerTask ${taskId} error:`, e.message);
    } finally {
        delete runningTasks[taskId];
        updateRunningTasksIndicator();
    }
}

async function runAllSprintTasks(sprintId) {
    if (sprintAutoRunState[sprintId]?.running) return;

    const maxConcurrent = parseInt(document.getElementById('maxConcurrentInput')?.value) || 5;
    sprintAutoRunState[sprintId] = { running: true, cancelled: false };

    // Expand this sprint so user sees progress
    expandedSprints[sprintId] = true;
    await refreshTasksBoardNew();

    console.log(`[AutoRun] Starting sprint ${sprintId}, maxConcurrent=${maxConcurrent}`);

    try {
        while (!sprintAutoRunState[sprintId]?.cancelled) {
            // Refresh all tasks from server
            const tasksData = await api('GET', '/api/tasks-list');
            const allTasksFresh = tasksData.tasks || [];
            allTasks = allTasksFresh; // update global cache

            const sprintTasks = allTasksFresh.filter(t => t.sprint_id === sprintId);

            // Check if all tasks are done
            const allDone = sprintTasks.every(t =>
                t.status === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' || t.status === '–æ—Ç–º–µ–Ω–µ–Ω–∞'
            );
            if (allDone) {
                console.log(`[AutoRun] Sprint ${sprintId}: all tasks done!`);
                break;
            }

            // Find actionable tasks (not finished)
            const actionable = sprintTasks.filter(t =>
                ['–Ω–æ–≤–∞—è', '–≤_—Ä–∞–±–æ—Ç–µ', '–Ω–∞_–ø—Ä–æ–≤–µ—Ä–∫–µ'].includes(t.status)
            );

            if (actionable.length === 0) break;

            // Find ready tasks: not currently running, dependencies met, have valid next step
            const ready = actionable.filter(t => {
                // Skip already running
                if (runningTasks[t.id]) return false;

                // Must have a valid next step
                const next = STATUS_NEXT_ROLE[t.status];
                if (!next) return false;

                // For '–Ω–æ–≤–∞—è' tasks, check all dependencies are done
                if (t.status === '–Ω–æ–≤–∞—è') {
                    const deps = t.depends_on || [];
                    return deps.every(depId => {
                        const depTask = allTasksFresh.find(x => x.id === depId);
                        return depTask && (depTask.status === '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' || depTask.status === '–æ—Ç–º–µ–Ω–µ–Ω–∞');
                    });
                }

                // –≤_—Ä–∞–±–æ—Ç–µ and –Ω–∞_–ø—Ä–æ–≤–µ—Ä–∫–µ are always ready to continue
                return true;
            });

            // Sort by task number (lower number = higher priority)
            ready.sort((a, b) => {
                const numA = parseInt(a.id.replace(/\D/g, ''));
                const numB = parseInt(b.id.replace(/\D/g, ''));
                return numA - numB;
            });

            // Calculate available slots
            const currentRunning = Object.keys(runningTasks).length;
            const slots = Math.max(0, maxConcurrent - currentRunning);
            const batch = ready.slice(0, slots);

            console.log(`[AutoRun] Sprint ${sprintId}: actionable=${actionable.length}, ready=${ready.length}, running=${currentRunning}, slots=${slots}, batch=${batch.length}`);

            if (batch.length === 0) {
                if (currentRunning > 0) {
                    // Wait for currently running tasks to finish
                    await new Promise(r => setTimeout(r, 3000));
                    await refreshTasksBoardNew();
                    continue;
                }
                // Nothing running and nothing ready - stuck (deps block or error)
                console.warn(`[AutoRun] Sprint ${sprintId}: no tasks ready and nothing running. Stopping.`);
                break;
            }

            // Update board to show running state
            await refreshTasksBoardNew();

            // Trigger batch in parallel
            const promises = batch.map(t => {
                const next = STATUS_NEXT_ROLE[t.status];
                const agentName = t[next.role] || '';
                const runtime = getAgentRuntime(agentName);
                return triggerTaskAutoRun(t.id, runtime);
            });

            await Promise.allSettled(promises);

            // Refresh board after batch completes
            await refreshTasksBoardNew();
        }
    } catch (e) {
        console.error('[AutoRun] Error:', e);
    } finally {
        const wasCancelled = sprintAutoRunState[sprintId]?.cancelled;
        delete sprintAutoRunState[sprintId];
        await refreshTasksBoardNew();
        console.log(`[AutoRun] Sprint ${sprintId} finished. ${wasCancelled ? '(cancelled)' : '(complete)'}`);
    }
}

function stopSprintAutoRun(sprintId) {
    if (sprintAutoRunState[sprintId]) {
        sprintAutoRunState[sprintId].cancelled = true;
        console.log(`[AutoRun] Sprint ${sprintId}: cancel requested`);
    }
}

// ‚îÄ‚îÄ Create Sprint Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showCreateSprintModal() {
    const body = `
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø—Ä–∏–Ω—Ç–∞</label>
        <input type="text" id="newSprintTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: MVP, –°–ø—Ä–∏–Ω—Ç 4 ‚Äî –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="newSprintDesc" rows="3" placeholder="–¶–µ–ª—å —Å–ø—Ä–∏–Ω—Ç–∞, –∫–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
    `;
    openModal('–°–æ–∑–¥–∞—Ç—å —Å–ø—Ä–∏–Ω—Ç', body,
        `<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
         <button class="btn primary" onclick="createSprintFromModal()">–°–æ–∑–¥–∞—Ç—å</button>`);
}

async function createSprintFromModal() {
    const title = document.getElementById('newSprintTitle').value.trim();
    if (!title) { alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ø—Ä–∏–Ω—Ç–∞'); return; }
    const data = {
        title,
        description: document.getElementById('newSprintDesc').value.trim(),
        created_by: 'boss',
    };
    try {
        const sprint = await api('POST', '/api/sprints', data);
        closeModal();
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π —Å–ø—Ä–∏–Ω—Ç
        expandedSprints[sprint.id] = true;
        await refreshTasksBoardNew();
        addSystemMessage(`–°–ø—Ä–∏–Ω—Ç ${sprint.id} —Å–æ–∑–¥–∞–Ω: ${sprint.title}`);
    } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
}

// ‚îÄ‚îÄ Create Task Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showCreateTaskModal() {
    const empOptions = Object.keys(employees).map(n => `<option value="${n}">${n} ‚Äî ${escapeHtml(employees[n].role || '')}</option>`).join('');
    const sprintOptions = '<option value="">‚Äî –±–µ–∑ —Å–ø—Ä–∏–Ω—Ç–∞ ‚Äî</option>' +
        allSprints.filter(s => s.status === '–∞–∫—Ç–∏–≤–Ω—ã–π').map(s =>
            `<option value="${s.id}">${s.id} ‚Äî ${escapeHtml(s.title)}</option>`
        ).join('');
    const taskOptions = allTasks.map(t =>
        `<option value="${t.id}">${t.id} ‚Äî ${escapeHtml(t.title.slice(0, 50))}</option>`
    ).join('');

    const body = `
        <label>–°–ø—Ä–∏–Ω—Ç</label>
        <select id="newTaskSprint">${sprintOptions}</select>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
        <input type="text" id="newTaskTitle" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="newTaskDesc" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        <label>–ó–∞–∫–∞–∑—á–∏–∫</label>
        <select id="newTaskCustomer">${empOptions}</select>
        <label>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</label>
        <select id="newTaskDeveloper">${empOptions}</select>
        <label>–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫</label>
        <select id="newTaskTester">${empOptions}</select>
        <label>–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–¥–∞—á (Ctrl+Click –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)</label>
        <select id="newTaskDeps" multiple size="4" style="min-height:80px;">${taskOptions}</select>
    `;
    openModal('–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É', body,
        `<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
         <button class="btn primary" onclick="createTaskFromModal()">–°–æ–∑–¥–∞—Ç—å</button>`);
}

async function createTaskFromModal() {
    const title = document.getElementById('newTaskTitle').value.trim();
    if (!title) { alert('–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); return; }
    const depsSelect = document.getElementById('newTaskDeps');
    const depends_on = Array.from(depsSelect.selectedOptions).map(o => o.value);
    const data = {
        title,
        description: document.getElementById('newTaskDesc').value.trim(),
        customer: document.getElementById('newTaskCustomer').value,
        developer: document.getElementById('newTaskDeveloper').value,
        tester: document.getElementById('newTaskTester').value,
        sprint_id: document.getElementById('newTaskSprint').value,
        depends_on: depends_on.length > 0 ? depends_on : undefined,
    };
    try {
        const task = await api('POST', '/api/tasks-list', data);
        closeModal();
        // –†–∞—Å–∫—Ä—ã—Ç—å —Å–ø—Ä–∏–Ω—Ç, –∫—É–¥–∞ –¥–æ–±–∞–≤–∏–ª–∏ –∑–∞–¥–∞—á—É
        if (task.sprint_id) expandedSprints[task.sprint_id] = true;
        await refreshTasksBoardNew();
        addSystemMessage(`–ó–∞–¥–∞—á–∞ ${task.id} —Å–æ–∑–¥–∞–Ω–∞: ${task.title}`);
    } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
}

function showCreateBacklogModal() {
    const sprintOptions = '<option value="">‚Äî –±–µ–∑ —Å–ø—Ä–∏–Ω—Ç–∞ ‚Äî</option>' +
        allSprints.filter(s => s.status === '–∞–∫—Ç–∏–≤–Ω—ã–π').map(s =>
            `<option value="${s.id}">${s.id} ‚Äî ${escapeHtml(s.title)}</option>`
        ).join('');

    const body = `
        <label>–°–ø—Ä–∏–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á –±—ç–∫–ª–æ–≥–∞</label>
        <select id="backlogSprint">${sprintOptions}</select>
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px; margin-top:12px;">
            –í—Å—Ç–∞–≤—å—Ç–µ JSON-–º–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á. –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞: { "title", "description", "customer", "developer", "tester" }.
            –ü–æ–ª–µ sprint_id –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ø—Ä–∏–Ω—Ç–∞.
        </p>
        <textarea id="backlogJson" rows="12" style="font-family:var(--mono); font-size:12px;" placeholder='[
  {
    "title": "–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏",
    "description": "–û–ø–∏—Å–∞–Ω–∏–µ",
    "customer": "boss",
    "developer": "developer_frontend",
    "tester": "qa_tester"
  }
]'></textarea>
    `;
    openModal('–°–æ–∑–¥–∞—Ç—å –±—ç–∫–ª–æ–≥', body,
        `<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
         <button class="btn primary" onclick="createBacklogFromModal()">–°–æ–∑–¥–∞—Ç—å</button>`);
}

async function createBacklogFromModal() {
    const text = document.getElementById('backlogJson').value.trim();
    const sprintId = document.getElementById('backlogSprint').value;
    let tasks;
    try { tasks = JSON.parse(text); } catch { alert('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON'); return; }
    if (!Array.isArray(tasks) || tasks.length === 0) { alert('–ù—É–∂–µ–Ω –Ω–µ–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–¥–∞—á'); return; }
    // –î–æ–±–∞–≤–ª—è–µ–º sprint_id –∫–æ –≤—Å–µ–º –∑–∞–¥–∞—á–∞–º
    if (sprintId) {
        tasks = tasks.map(t => ({ ...t, sprint_id: sprintId }));
    }
    try {
        const result = await api('POST', '/api/tasks-list', { tasks });
        closeModal();
        if (sprintId) expandedSprints[sprintId] = true;
        await refreshTasksBoardNew();
        addSystemMessage(`–°–æ–∑–¥–∞–Ω–æ ${result.count} –∑–∞–¥–∞—á`);
    } catch (e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
}

// ‚îÄ‚îÄ Old Tasks Board (tasks.md) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showOldTasksBoard() {
    hideAllScreens();
    document.getElementById('tasksScreen').style.display = 'flex';
    refreshOldTasksBoard();
}

async function refreshOldTasksBoard() {
    const el = document.getElementById('oldTasksBoardContent');
    el.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    try {
        const data = await api('GET', '/api/tasks');
        el.textContent = data.content || '';
    } catch (e) { el.textContent = '–û—à–∏–±–∫–∞: ' + e.message; }
}

// ‚îÄ‚îÄ Ensure Agents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function ensureAgents() {
    addSystemMessage('–ü—Ä–æ–≤–µ—Ä—è—é –∞–≥–µ–Ω—Ç–æ–≤...');
    try {
        const result = await api('POST', '/api/ensure-agents');
        for (const r of result.results) {
            addSystemMessage(`–ê–≥–µ–Ω—Ç "${r.agent}": ${r.status}`, r.status === 'error');
        }
        await loadAgents();
    } catch (e) { addSystemMessage('–û—à–∏–±–∫–∞: ' + e.message, true); }
}

async function createCursorChats() {
    addSystemMessage('–°–æ–∑–¥–∞—é —á–∞—Ç—ã Cursor...');
    try {
        const result = await api('POST', '/api/cursor-create-chats');
        for (const r of result.results || []) {
            if (r.created && r.chat_id) addSystemMessage(`Cursor —á–∞—Ç "${r.agent}": ${r.chat_id}`);
            else if (r.chat_id) addSystemMessage(`–ß–∞—Ç "${r.agent}" —É–∂–µ –µ—Å—Ç—å`);
            else addSystemMessage(`"${r.agent}": ${r.error || '–Ω–µ —Å–æ–∑–¥–∞–Ω'}`, true);
        }
    } catch (e) { addSystemMessage('–û—à–∏–±–∫–∞: ' + e.message, true); }
}

// ‚îÄ‚îÄ Running tasks header indicator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateRunningTasksIndicator() {
    const count = Object.keys(runningTasks).length;
    const el = document.getElementById('runningTasksIndicator');
    const countEl = document.getElementById('runningTasksCount');
    if (count > 0) {
        el.style.display = 'flex';
        countEl.textContent = count;
    } else {
        el.style.display = 'none';
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª–ª–∏–Ω–≥ running tasks (–Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–æ—Å–∫–∞ –≤–∏–¥–Ω–∞)
let globalRunningPollTimer = null;

function startGlobalRunningPoll() {
    if (globalRunningPollTimer) return;
    globalRunningPollTimer = setInterval(async () => {
        await fetchRunningTasks();
        updateRunningTasksIndicator();
    }, 5000);
}

// ‚îÄ‚îÄ Git Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let gitStatus = null;
let gitHistoryExpanded = false;
let gitAutoRefreshTimer = null;

async function loadGitStatus() {
    const container = document.getElementById('gitStatusContainer');

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ header
    updateGitHeaderIndicator('loading');

    try {
        const data = await api('GET', '/api/git/status');
        gitStatus = data;
        if (container) renderGitSection(data);
        updateGitHeaderIndicator('success', data);
    } catch (e) {
        console.warn('Git –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e.message);
        if (container) renderGitUnavailable(e.message);
        updateGitHeaderIndicator('error', null, e.message);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä git-—Å—Ç–∞—Ç—É—Å–∞ –≤ header
function updateGitHeaderIndicator(state, data = null, errorMsg = null) {
    const branchEl = document.getElementById('gitBranchHeader');
    const dotEl = document.getElementById('gitDotHeader');
    const indicator = document.getElementById('gitStatusIndicator');

    if (!branchEl || !dotEl || !indicator) return;

    switch(state) {
        case 'loading':
            branchEl.textContent = '...';
            dotEl.className = 'git-dot loading';
            indicator.title = '–ó–∞–≥—Ä—É–∑–∫–∞ git-—Å—Ç–∞—Ç—É—Å–∞...';
            break;

        case 'success':
            if (data && data.branch) {
                branchEl.textContent = data.branch;
                const stagedCount = (data.staged || []).length;
                const unstagedCount = (data.unstaged || []).length;
                const untrackedCount = (data.untracked || []).length;
                const hasChanges = stagedCount + unstagedCount + untrackedCount > 0;

                dotEl.className = 'git-dot ' + (hasChanges ? 'dirty' : 'clean');

                // –§–æ—Ä–º–∏—Ä—É–µ–º tooltip
                let tooltip = `–í–µ—Ç–∫–∞: ${data.branch}\n`;
                if (hasChanges) {
                    if (stagedCount > 0) tooltip += `Staged: ${stagedCount} —Ñ–∞–π–ª(–æ–≤)\n`;
                    if (unstagedCount > 0) tooltip += `–ò–∑–º–µ–Ω–µ–Ω–æ: ${unstagedCount} —Ñ–∞–π–ª(–æ–≤)\n`;
                    if (untrackedCount > 0) tooltip += `–ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è: ${untrackedCount} —Ñ–∞–π–ª(–æ–≤)`;
                } else {
                    tooltip += '–ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π';
                }
                indicator.title = tooltip.trim();
            } else {
                branchEl.textContent = '‚Äî';
                dotEl.className = 'git-dot';
                indicator.title = 'Git –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω';
            }
            break;

        case 'error':
            branchEl.textContent = '‚Äî';
            dotEl.className = 'git-dot error';
            indicator.title = errorMsg || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è git-—Å—Ç–∞—Ç—É—Å–∞';
            break;
    }
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ git-–æ–ø–µ—Ä–∞—Ü–∏—è—Ö
function showGitToast(message, type = 'error') {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π toast –µ—Å–ª–∏ –µ—Å—Ç—å
    const existing = document.querySelector('.git-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `git-toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => toast.remove(), 5000);
}

function renderGitUnavailable(message = 'Git –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω') {
    const container = document.getElementById('gitStatusContainer');
    if (!container) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ª–∏ –æ—à–∏–±–∫–∞ "Git not initialized"
    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º JSON-–æ—Ç–≤–µ—Ç {"initialized": false}
    const lowerMsg = message.toLowerCase();
    const isNotInitialized = lowerMsg.includes('initialized') ||
                              lowerMsg.includes('not a git') ||
                              lowerMsg.includes('not initialized') ||
                              lowerMsg.includes('"initialized"') ||
                              lowerMsg.includes('false');

    if (isNotInitialized) {
        container.innerHTML = `
            <div class="git-unavailable">
                <div class="icon">üìÅ</div>
                <p>Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</p>
                <button class="btn primary" onclick="initGitRepo()" style="margin-top: 10px;">
                    üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Git
                </button>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="git-unavailable">
                <div class="icon">‚ö†Ô∏è</div>
                <p>${escapeHtml(message)}</p>
            </div>
        `;
    }
}

async function initGitRepo() {
    const container = document.getElementById('gitStatusContainer');
    if (container) {
        container.innerHTML = `
            <div class="git-unavailable">
                <div class="icon">‚è≥</div>
                <p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...</p>
            </div>
        `;
    }

    try {
        const result = await api('POST', '/api/git/init', { create_gitignore: true });
        if (result.success) {
            showNotification('Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' + (result.gitignore_created ? ' (.gitignore —Å–æ–∑–¥–∞–Ω)' : ''), 'success');
            showGitToast('Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
            await loadGitStatus();
        } else {
            throw new Error(result.message || '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
        }
    } catch (e) {
        showNotification('–û—à–∏–±–∫–∞: ' + e.message, 'error');
        showGitToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message, 'error');
        updateGitHeaderIndicator('error', null, e.message);
        renderGitUnavailable(e.message);
    }
}

function renderGitSection(data) {
    const container = document.getElementById('gitStatusContainer');
    if (!container) return;

    if (!data || !data.branch) {
        renderGitUnavailable('–ù–µ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π');
        return;
    }

    // –ü–æ–¥—Å—á—ë—Ç —Ñ–∞–π–ª–æ–≤ –∏–∑ –º–∞—Å—Å–∏–≤–æ–≤
    const stagedCount = (data.staged || []).length;
    const unstagedCount = (data.unstaged || []).length;
    const untrackedCount = (data.untracked || []).length;
    const isClean = stagedCount === 0 && unstagedCount === 0 && untrackedCount === 0;
    const statusClass = isClean ? 'clean' : 'dirty';
    const statusText = isClean ? 'clean' : 'dirty';

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    let changesHtml = '';
    if (stagedCount > 0 || unstagedCount > 0 || untrackedCount > 0) {
        changesHtml = `<div class="git-changes">`;
        if (stagedCount > 0) changesHtml += `<span class="staged">+${stagedCount} staged</span> `;
        if (unstagedCount > 0) changesHtml += `<span class="unstaged">${unstagedCount} modified</span> `;
        if (untrackedCount > 0) changesHtml += `<span class="untracked">${untrackedCount} untracked</span>`;
        changesHtml += `</div>`;
    }

    container.innerHTML = `
        <div class="git-status-card">
            <div class="git-branch-row">
                <span class="git-branch-icon">üåø</span>
                <span class="git-branch-name">${escapeHtml(data.branch)}</span>
                <span class="git-status-dot ${statusClass}" title="${statusText}"></span>
            </div>
            ${changesHtml}
        </div>

        <div class="git-actions">
            <button class="btn sm" onclick="showGitCommitModal()" ${isClean ? 'disabled title="–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"' : ''}>üìù Commit</button>
            <button class="btn sm" onclick="gitPush()">‚¨ÜÔ∏è Push</button>
            <button class="btn sm" onclick="showGitPRModal()">üîÄ PR</button>
        </div>

        <div class="git-history">
            <div class="git-history-toggle" onclick="toggleGitHistory()">
                <span class="arrow ${gitHistoryExpanded ? 'open' : ''}" id="gitHistoryArrow">‚ñ∂</span>
                <span>–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20)</span>
            </div>
            <div class="git-history-list ${gitHistoryExpanded ? 'open' : ''}" id="gitHistoryList">
                <div style="text-align:center; padding:10px; color:var(--text-dim);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    `;

    if (gitHistoryExpanded) {
        loadGitHistory();
    }
}

async function toggleGitHistory() {
    gitHistoryExpanded = !gitHistoryExpanded;
    const arrow = document.getElementById('gitHistoryArrow');
    const list = document.getElementById('gitHistoryList');

    if (arrow) arrow.classList.toggle('open', gitHistoryExpanded);
    if (list) list.classList.toggle('open', gitHistoryExpanded);

    if (gitHistoryExpanded) {
        await loadGitHistory();
    }
}

async function loadGitHistory() {
    const list = document.getElementById('gitHistoryList');
    if (!list) return;

    try {
        const data = await api('GET', '/api/git/log?limit=20');
        const commits = data.commits || [];

        if (commits.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-dim);">–ù–µ—Ç –∫–æ–º–º–∏—Ç–æ–≤</div>';
            return;
        }

        list.innerHTML = commits.map(c => `
            <div class="git-commit-item">
                <span class="git-commit-hash">${escapeHtml(c.hash?.slice(0, 7) || '?')}</span>
                <span class="git-commit-msg" title="${escapeHtml(c.message || '')}">${escapeHtml(c.message?.split('\n')[0] || '')}</span>
                <span class="git-commit-time">${formatGitTime(c.date)}</span>
            </div>
        `).join('');
    } catch (e) {
        list.innerHTML = `<div style="text-align:center; padding:10px; color:var(--danger);">–û—à–∏–±–∫–∞: ${escapeHtml(e.message)}</div>`;
    }
}

function formatGitTime(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

    if (diffHours < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diffHours < 24) return `${diffHours}—á –Ω–∞–∑–∞–¥`;
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}–¥ –Ω–∞–∑–∞–¥`;
    return date.toLocaleDateString('ru');
}

// ‚îÄ‚îÄ Git Commit Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function showGitCommitModal() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
    const loadingBody = `
        <div style="text-align:center; padding:20px; color:var(--text-dim);">
            <div style="font-size:24px; margin-bottom:10px;">‚è≥</div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...</p>
        </div>
    `;
    openModal('Commit', loadingBody, '<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>');

    try {
        const data = await api('GET', '/api/git/status');

        const staged = data.staged || [];
        const unstaged = data.unstaged || [];
        const untracked = data.untracked || [];
        const isClean = staged.length === 0 && unstaged.length === 0 && untracked.length === 0;

        if (isClean) {
            closeModal();
            alert('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞');
            return;
        }

        let filesHtml = '';
        if (staged.length > 0) {
            filesHtml += `<div style="font-size:12px; color:var(--success); margin:8px 0 4px;">Staged (${staged.length})</div>`;
            filesHtml += staged.map(f => renderCommitFileItem(f, true)).join('');
        }
        if (unstaged.length > 0) {
            filesHtml += `<div style="font-size:12px; color:var(--warning); margin:8px 0 4px;">Modified (${unstaged.length})</div>`;
            filesHtml += unstaged.map(f => renderCommitFileItem(f, false)).join('');
        }
        if (untracked.length > 0) {
            filesHtml += `<div style="font-size:12px; color:var(--text-dim); margin:8px 0 4px;">Untracked (${untracked.length})</div>`;
            filesHtml += untracked.map(f => renderCommitFileItem(f, false)).join('');
        }

        const body = `
            <div class="commit-type-row">
                <select id="commitType">
                    <option value="feat">feat</option>
                    <option value="fix">fix</option>
                    <option value="docs">docs</option>
                    <option value="style">style</option>
                    <option value="refactor">refactor</option>
                    <option value="test">test</option>
                    <option value="chore">chore</option>
                </select>
                <input type="text" id="commitScope" placeholder="scope (optional)">
            </div>
            <label>–°–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea id="commitMessage" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."></textarea>

            <label>–§–∞–π–ª—ã</label>
            <div class="commit-files-list">
                ${filesHtml}
            </div>
        `;

        openModal('Commit', body,
            `<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
             <button class="btn primary" onclick="submitGitCommit()">Commit</button>`);

    } catch (e) {
        closeModal();
        alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + e.message);
    }
}

function renderCommitFileItem(file, isStaged) {
    // file –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π (–∏–º—è —Ñ–∞–π–ª–∞) –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º
    const path = typeof file === 'string' ? file : (file.path || file.file || '');

    return `
        <div class="commit-file-item">
            <input type="checkbox" name="commitFiles" value="${escapeHtml(path)}" ${isStaged ? 'checked' : ''}>
            <span class="commit-file-path" title="${escapeHtml(path)}">${escapeHtml(path)}</span>
        </div>
    `;
}

async function submitGitCommit() {
    const type = document.getElementById('commitType').value;
    const scope = document.getElementById('commitScope').value.trim();
    const message = document.getElementById('commitMessage').value.trim();

    if (!message) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞');
        return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    const checkboxes = document.querySelectorAll('input[name="commitFiles"]:checked');
    const files = Array.from(checkboxes).map(cb => cb.value);

    if (files.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª');
        return;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
    const fullMessage = scope
        ? `${type}(${scope}): ${message}`
        : `${type}: ${message}`;

    try {
        const result = await api('POST', '/api/git/commit', {
            message: fullMessage,
            files: files
        });

        closeModal();
        addSystemMessage(`Commit —Å–æ–∑–¥–∞–Ω: ${result.hash?.slice(0, 7) || 'OK'}`);
        showGitToast('Commit —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
        await loadGitStatus();
    } catch (e) {
        const errorMsg = parseGitError(e.message);
        showGitToast('Git –æ—à–∏–±–∫–∞: ' + errorMsg, 'error');
        updateGitHeaderIndicator('error', null, errorMsg);
    }
}

// ‚îÄ‚îÄ Git Push ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function gitPush() {
    if (!confirm('–í—ã–ø–æ–ª–Ω–∏—Ç—å git push?')) return;

    try {
        const result = await api('POST', '/api/git/push');
        addSystemMessage(`Push –≤—ã–ø–æ–ª–Ω–µ–Ω: ${result.message || 'OK'}`);
        showGitToast('Push –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
        await loadGitStatus();
    } catch (e) {
        const errorMsg = parseGitError(e.message);
        showGitToast('Git –æ—à–∏–±–∫–∞: ' + errorMsg, 'error');
        updateGitHeaderIndicator('error', null, errorMsg);
    }
}

// –ü–∞—Ä—Å–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö git –¥–ª—è –ø–æ–Ω—è—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
function parseGitError(message) {
    const lowerMsg = (message || '').toLowerCase();

    if (lowerMsg.includes('could not resolve host') || lowerMsg.includes('unable to access')) {
        return '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ remote —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é';
    }
    if (lowerMsg.includes('permission denied') || lowerMsg.includes('authentication failed')) {
        return '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏';
    }
    if (lowerMsg.includes('merge conflict') || lowerMsg.includes('conflict')) {
        return '–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–ª–∏—è–Ω–∏—è';
    }
    if (lowerMsg.includes('already exists')) {
        return '–í–µ—Ç–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
    }
    if (lowerMsg.includes('not a git repository')) {
        return '–ù–µ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π';
    }
    if (lowerMsg.includes('rejected') || lowerMsg.includes('failed to push')) {
        return 'Push –æ—Ç–∫–ª–æ–Ω—ë–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–µ–Ω pull)';
    }
    if (lowerMsg.includes('nothing to commit')) {
        return '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞';
    }

    return message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
}

// ‚îÄ‚îÄ Git PR Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function showGitPRModal() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Ç–∫–∏
    const loadingBody = `
        <div style="text-align:center; padding:20px; color:var(--text-dim);">
            <div style="font-size:24px; margin-bottom:10px;">‚è≥</div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ç–æ–∫...</p>
        </div>
    `;
    openModal('Create Pull Request', loadingBody, '<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>');

    try {
        const [statusData, branchesData] = await Promise.all([
            api('GET', '/api/git/status'),
            api('GET', '/api/git/branches')
        ]);

        const currentBranch = statusData.branch || 'unknown';
        const branches = branchesData.branches || [];

        // –û–ø—Ü–∏–∏ –¥–ª—è base branch (–∏—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É)
        const baseOptions = branches
            .filter(b => b !== currentBranch)
            .map(b => `<option value="${escapeHtml(b)}" ${b === 'develop' ? 'selected' : ''}>${escapeHtml(b)}</option>`)
            .join('');

        const body = `
            <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:4px;">Branch</label>
                <div style="font-family:var(--mono); font-size:14px; color:var(--accent);">${escapeHtml(currentBranch)}</div>
            </div>

            <label>Base branch</label>
            <select id="prBaseBranch">${baseOptions}</select>

            <label>Title</label>
            <input type="text" id="prTitle" placeholder="PR title" value="${escapeHtml(currentBranch)}">

            <label>Description</label>
            <textarea id="prDescription" rows="6" placeholder="## Summary&#10;- ...&#10;&#10;## Changes&#10;- ..."></textarea>
        `;

        openModal('Create Pull Request', body,
            `<button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
             <button class="btn primary" onclick="submitGitPR()">Create PR</button>`);

    } catch (e) {
        closeModal();
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

async function submitGitPR() {
    const baseBranch = document.getElementById('prBaseBranch').value;
    const title = document.getElementById('prTitle').value.trim();
    const description = document.getElementById('prDescription').value.trim();

    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ PR');
        return;
    }

    try {
        const result = await api('POST', '/api/git/pr', {
            base: baseBranch,
            title: title,
            body: description
        });

        closeModal();

        if (result.url) {
            addSystemMessage(`PR —Å–æ–∑–¥–∞–Ω: ${result.url}`);
            showGitToast('PR —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
            if (confirm(`PR —Å–æ–∑–¥–∞–Ω!\n\n–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ?\n${result.url}`)) {
                window.open(result.url, '_blank');
            }
        } else {
            addSystemMessage(`PR —Å–æ–∑–¥–∞–Ω: ${result.number || 'OK'}`);
            showGitToast('PR —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
        }

        await loadGitStatus();
    } catch (e) {
        const errorMsg = parseGitError(e.message);
        showGitToast('Git –æ—à–∏–±–∫–∞: ' + errorMsg, 'error');
    }
}

// ‚îÄ‚îÄ Git Auto-refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startGitAutoRefresh() {
    if (gitAutoRefreshTimer) return;
    gitAutoRefreshTimer = setInterval(() => {
        loadGitStatus();
    }, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
}

function stopGitAutoRefresh() {
    if (gitAutoRefreshTimer) {
        clearInterval(gitAutoRefreshTimer);
        gitAutoRefreshTimer = null;
    }
}

// ‚îÄ‚îÄ Refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function refreshAll() {
    await Promise.all([checkStatus(), loadEmployees(), loadAgents(), fetchRunningTasks(), loadSprints(), loadGitStatus()]);
    updateRunningTasksIndicator();
}

async function loadSprints() {
    try {
        const data = await api('GET', '/api/sprints');
        allSprints = data.sprints || [];
    } catch {
        allSprints = [];
    }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

(async () => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–∫–ª—é—á–∞—è —Ç–µ–º—É) —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    await loadSettings();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç
    try {
        const status = await api('GET', '/api/status');

        if (!status.has_project) {
            // –ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º project-picker
            showProjectPicker();
            return;
        }
    } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:', e.message);
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º project-picker
        showProjectPicker();
        return;
    }

    // –ï—Å—Ç—å –ø—Ä–æ–µ–∫—Ç ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    await Promise.all([checkStatus(), loadEmployees(), loadAgents(), fetchRunningTasks(), loadSprints(), loadGitStatus()]);
    updateRunningTasksIndicator();
    setInterval(checkStatus, 10000);
    startGlobalRunningPoll();
    startGitAutoRefresh();

    // –ü–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (–¥–ª—è –∞–≤—Ç–æ–≤—ã–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏)
    setInterval(() => {
        fetch('/api/ping', { method: 'POST' }).catch(() => {});
    }, 5000);
})();
</script>

</body>
</html>
