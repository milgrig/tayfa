# Правила работы в команде

## Рабочая папка агентов

Все агенты работают в корне проекта (workdir). Из него видны:
- Файлы и папки проекта.
- `.tayfa/` — папка команды: common/, boss/, hr/, <имя>/.

## Где что хранить

- **Корень проекта** — **работа по проекту**: код, фронтенд/бэкенд, дизайн-макеты, контент продукта, документация. Все артефакты проекта здесь.
- **`.tayfa/`** — **коммуникация и учёт**: задачи, реестр сотрудников, правила, промпты, профили и навыки агентов.

---

## Система задач и спринтов

### Центральное хранилище

Все задачи и спринты — в **`.tayfa/common/tasks.json`**, управляются через **`.tayfa/common/task_manager.py`**. Оркестратор отображает их на доске задач.

**Не редактируй `tasks.json` вручную** — используй `task_manager.py`.

### Спринты

Спринт — группа задач, объединённых общей целью. **Все задачи должны быть привязаны к спринту.**

- Спринты создаёт **только boss**.
- При создании спринта автоматически создаётся задача **«Финализировать спринт»**, которая зависит от всех остальных задач спринта.
- В оркестраторе спринты отображаются списком (новые сверху, старые внизу). Каждый спринт раскрывается, и внутри — канбан-доска с задачами.

**Статусы спринта:** `активный` → `завершён`.

```bash
# Создать спринт
python .tayfa/common/task_manager.py create-sprint "Название спринта" "Описание"

# Список спринтов
python .tayfa/common/task_manager.py sprints

# Получить спринт
python .tayfa/common/task_manager.py sprint S001
```

### Статусы задач

| Статус | Описание |
|--------|----------|
| `новая` | Задача создана, ещё не начата |
| `в_работе` | Разработчик выполняет задачу |
| `на_проверке` | Тестировщик проверяет результат |
| `выполнена` | Задача завершена и принята |
| `отменена` | Задача отменена |

### Роли в задаче

Каждая задача имеет **3 исполнителей**:

| Роль | Что делает |
|------|-----------|
| **Постановщик (customer)** | При статусе «новая» → детализирует требования задачи, переводит в «в_работе» |
| **Разработчик (developer)** | При статусе «в_работе» → реализует, переводит в «на_проверке» |
| **Тестировщик (tester)** | При статусе «на_проверке» → проверяет, переводит в «выполнена» или возвращает в «в_работе» |

### Специализация сотрудников по ролям

При создании сотрудников и назначении на задачи учитывай их **предрасположенность к ролям**:

| Сильные стороны | Хорош как |
|-----------------|-----------|
| Понимание бизнеса, умение формулировать требования, знание продукта, аналитический склад ума | **Постановщик** |
| Технические навыки, умение реализовывать, знание кода | **Разработчик** |
| Внимание к деталям, критическое мышление, умение находить баги | **Тестировщик** |

**Типичные роли для каждой функции:**
- **Постановщик**: `analyst`, `product_manager`, `business_analyst`, `specifier` — специалисты, которые умеют детализировать требования
- **Разработчик**: `developer_python`, `developer_frontend`, `developer_backend` — технические специалисты
- **Тестировщик**: `qa_tester`, `qa_engineer` — специалисты по качеству

### Зависимости задач (depends_on)

У задачи может быть поле **`depends_on`** — список ID задач, от которых она зависит. Это означает, что задача не может быть начата, пока зависимости не выполнены.

- На доске задач зависимости отображаются с индикатором: ✓ (выполнена) или ● (ещё не выполнена).
- Задача **«Финализировать спринт»** автоматически зависит от всех задач спринта.

### Кто создаёт задачи

Задачи создаёт **только boss**:

```bash
# Одна задача (привязана к спринту S001)
python .tayfa/common/task_manager.py create "Заголовок" "Описание" \
  --customer analyst --developer developer_frontend --tester qa_tester \
  --sprint S001

# Задача с зависимостями
python .tayfa/common/task_manager.py create "Заголовок" "Описание" \
  --customer product_manager --developer developer_python --tester qa_tester \
  --sprint S001 --depends-on T001 T002

# Бэклог (массовое создание)
python .tayfa/common/task_manager.py backlog backlog.json
```

**Важно:** Boss **не ставит себя постановщиком** в обычных задачах. Постановщиком назначается аналитик или специалист по продукту — тот, кто умеет детализировать требования.

### Когда boss может быть постановщиком

Boss может быть постановщиком только в особых случаях:
- Задача пришла напрямую от внешнего заказчика с чёткими требованиями
- Стратегическая задача, где boss сам определяет направление
- Задача на исследование, где нужен взгляд сверху

### Рабочий процесс

```
Boss создаёт спринт → автоматически создаётся задача «Финализировать спринт»
Boss создаёт задачи в спринте → [новая]
   → Постановщик детализирует → [в_работе]
      → Разработчик выполняет → [на_проверке]
         → Тестировщик проверяет → [выполнена]
                                 ↘ [в_работе] (если проблемы)
Все задачи спринта выполнены → Финализировать спринт
```

На каждом этапе в оркестраторе нажимается кнопка — соответствующий агент получает промпт и выполняет работу.

### Как агент работает с задачей

1. Получает информацию: ID, заголовок, описание, роль, предыдущий результат, зависимости.
2. Выполняет работу.
3. Записывает результат **в обязательном формате handoff** (см. ниже).
4. Меняет статус.

---

## Общение по задачам — папка discussions/

### Где ведётся диалог

Все сообщения по задаче пишутся в файл:

```
.tayfa/common/discussions/{task_id}.md
```

Например: `.tayfa/common/discussions/T001.md`

### Почему не в tasks.json?

- `tasks.json` — **краткий статус** задачи (для оркестратора)
- `discussions/` — **полная история** общения (для агентов и человека)

### Автоматическое создание файла

**Файл создаётся автоматически** при создании задачи через `task_manager.py`. Boss передаёт описание задачи — оно автоматически записывается в файл как первоначальная постановка.

**Что происходит при `task_manager.py create`:**
1. Создаётся задача в `tasks.json`
2. Создаётся файл `.tayfa/common/discussions/{task_id}.md`
3. В файл записывается заголовок и описание от boss'а

**Шаблон автоматически созданного файла:**

```markdown
# T001: Заголовок задачи

**Спринт:** S001
**Постановщик:** analyst | **Разработчик:** developer | **Тестировщик:** tester

---

## [2025-01-15 10:00] boss (создание задачи)

### Описание задачи

[Описание, которое boss передал при создании]

---

<!-- Далее агенты дописывают свои записи -->
```

### Формат записей агентов

```markdown
---

## [2025-01-15 10:00] analyst (постановщик)

### Детализация задачи
...

---

## [2025-01-15 14:00] developer (разработчик)

### Результат выполнения
...

---

## [2025-01-15 16:00] tester (тестировщик)

### Результат тестирования
...
```

### Правила работы с discussions/

1. **Создание файла**: Автоматически при создании задачи (boss)
2. **Дописывание**: Каждый агент **дописывает** в конец файла, не удаляя предыдущее
3. **Разделитель**: Между сообщениями — `---`
4. **Заголовок сообщения**: `## [дата время] имя_агента (роль)`
5. **Чтение**: Перед работой агент **читает весь файл** чтобы понять контекст

### ⚠️ Discussions — НЕ для вопросов!

**Категорически запрещено:**
- ❌ Задавать вопросы и ждать ответа
- ❌ Писать "уточните требования" или "нужны дополнительные данные"
- ❌ Останавливать работу из-за неясностей

**Агент должен:**
- ✅ **Принять решение самостоятельно** в рамках своей роли
- ✅ **Документировать решение** в discussions как обратную связь
- ✅ **Выполнить задачу** и передать следующему

**Формат обратной связи (если было неясно):**

```markdown
### Принятые решения

В требованиях было неоднозначно: [описание неясности].
**Решение:** Сделал [так-то], потому что [обоснование].

Если нужно иначе — создайте новую задачу на доработку.
```

**Почему так:**
- Агенты работают асинхронно — никто не ждёт ответов
- Каждый агент — эксперт в своей области и принимает решения
- Лучше сделать и получить фидбэк, чем ждать уточнений
- Если решение неверное — тестировщик вернёт на доработку

### Что писать в discussions/, а что в task_manager.py result

| Куда | Что писать |
|------|-----------|
| `discussions/{task_id}.md` | Полный handoff с деталями, acceptance criteria, test cases, результаты |
| `task_manager.py result` | Краткий статус: "Детализировано, см. discussions/T001.md" |

### Пример workflow

```bash
# 1. Постановщик создаёт файл и детализирует
echo "# T001: Название задачи

---

## [$(date '+%Y-%m-%d %H:%M')] analyst (постановщик)

### Детализация задачи
...
" > .tayfa/common/discussions/T001.md

# 2. Записывает краткий статус
python .tayfa/common/task_manager.py result T001 "Детализировано. См. .tayfa/common/discussions/T001.md"
python .tayfa/common/task_manager.py status T001 в_работе

# 3. Разработчик читает файл, дописывает результат
cat >> .tayfa/common/discussions/T001.md << 'EOF'

---

## [2025-01-15 14:00] developer (разработчик)

### Результат выполнения
...
EOF

# 4. Записывает краткий статус
python .tayfa/common/task_manager.py result T001 "Выполнено. См. .tayfa/common/discussions/T001.md"
python .tayfa/common/task_manager.py status T001 на_проверке
```

---

## Бэклог

### Что такое бэклог

Бэклог — хранилище неоформленных идей и задач. Это промежуточное звено между идеей и формальной задачей в спринте.

**Когда использовать:**
- Есть идея, но она ещё не проработана
- Функционал нужен в будущем, но не сейчас
- Нужно зафиксировать идею, чтобы не забыть

**Отличие от задач:**
- Бэклог — черновики, задачи — формализованные требования
- Бэклог не привязан к спринту, задачи — всегда в спринте
- Бэклог может редактироваться, задачи следуют workflow

### Кто работает с бэклогом

- **Любой сотрудник** — может добавлять записи
- **Boss** — управляет переносом в спринты, приоритизирует

### Workflow с бэклогом

1. **Добавление идеи**
   ```bash
   python .tayfa/common/backlog_manager.py add "Название идеи" \
     --description "Описание" \
     --priority medium
   ```

2. **Планирование спринта**
   - Boss просматривает бэклог
   - Отмечает важные записи флагом `next_sprint`
   - При создании спринта автоматически включает отмеченные записи

3. **Создание спринта из бэклога**
   ```bash
   # Автоматически включить все записи с next_sprint=true
   python .tayfa/common/task_manager.py create-sprint "Название" "Описание" \
     --include-backlog
   ```

4. **Перенос отдельной записи**
   ```bash
   # Создать задачу из конкретной записи бэклога
   python .tayfa/common/task_manager.py create-from-backlog B001 \
     --customer analyst --developer developer --tester tester \
     --sprint S002
   ```

### Флаг "В следующий спринт"

Флаг `next_sprint` — метка для записей, которые boss планирует включить в следующий спринт.

```bash
# Переключить флаг
python .tayfa/common/backlog_manager.py toggle B001

# Посмотреть только записи для следующего спринта
python .tayfa/common/backlog_manager.py next-sprint
```

Подробнее: `.tayfa/common/Rules/backlog.md`

---

## Форматы передачи задач (Handoff)

**Критически важно:** Каждый агент при передаче задачи следующему **обязан** использовать структурированный формат в `discussions/{task_id}.md`. Это гарантирует, что следующий агент точно понимает, что делать.

### Handoff: Постановщик → Разработчик

Когда постановщик (customer) переводит задачу в `в_работе`:

**1. Создать/дописать в `discussions/T001.md`:**

```markdown
---

## [YYYY-MM-DD HH:MM] {имя_агента} (постановщик)

### Детализация задачи

#### Что нужно сделать
[Суть задачи — 2-3 предложения]

#### Acceptance Criteria
- [ ] Критерий 1: конкретное, измеримое требование
- [ ] Критерий 2: конкретное, измеримое требование
- [ ] Критерий 3: конкретное, измеримое требование

#### Test Cases
1. [Действие] → [Ожидаемый результат]
2. [Действие] → [Ожидаемый результат]
3. [Граничный случай] → [Ожидаемый результат]

#### Технические детали (опционально)
- Файлы для изменения: ...
- API/интерфейсы: ...
- Ограничения: ...
```

**2. Записать краткий статус:**

```bash
python .tayfa/common/task_manager.py result T001 "Детализировано. См. .tayfa/common/discussions/T001.md"
python .tayfa/common/task_manager.py status T001 в_работе
```

**Чек-лист постановщика:**
- [ ] Критерии конкретные и измеримые (не "сделай красиво")
- [ ] Test cases покрывают happy path + edge cases
- [ ] Указаны все зависимости и ограничения

### Handoff: Разработчик → Тестировщик

Когда разработчик (developer) переводит задачу в `на_проверке`:

**1. Дописать в `discussions/T001.md`:**

```markdown
---

## [YYYY-MM-DD HH:MM] {имя_агента} (разработчик)

### Результат выполнения

#### Что сделано
- [Конкретное изменение 1]
- [Конкретное изменение 2]
- [Конкретное изменение 3]

#### Изменённые файлы
- `path/to/file1.py` — что изменено
- `path/to/file2.py` — что изменено

#### Как проверить
- Команда запуска: `python script.py` или URL: http://localhost:3000/...
- Тестовые данные: ...

#### Чек-лист для тестировщика
- [ ] Проверить критерий 1: как именно проверить
- [ ] Проверить критерий 2: как именно проверить
- [ ] Проверить критерий 3: как именно проверить

#### Известные ограничения
- Что НЕ реализовано / отложено на потом
- Известные проблемы (если есть)
```

**2. Записать краткий статус:**

```bash
python .tayfa/common/task_manager.py result T001 "Выполнено. См. .tayfa/common/discussions/T001.md"
python .tayfa/common/task_manager.py status T001 на_проверке
```

**Чек-лист разработчика:**
- [ ] Все acceptance criteria выполнены
- [ ] Указаны все изменённые файлы
- [ ] Есть инструкция как проверить
- [ ] Чек-лист для тестировщика соответствует критериям

### Handoff: Тестировщик → Завершение / Возврат

**Если всё ОК — дописать в `discussions/T001.md`:**

```markdown
---

## [YYYY-MM-DD HH:MM] {имя_агента} (тестировщик)

### Результат тестирования: ✅ ПРИНЯТО

#### Проверенные критерии
- [✓] Критерий 1: проверено так-то
- [✓] Критерий 2: проверено так-то
- [✓] Критерий 3: проверено так-то

#### Дополнительные проверки
- Edge cases: ✓ OK
- Регрессия: ✓ OK

#### Замечания
Нет / Мелкие замечания (не блокируют)
```

```bash
python .tayfa/common/task_manager.py result T001 "✅ Принято. См. .tayfa/common/discussions/T001.md"
python .tayfa/common/task_manager.py status T001 выполнена
```

**Если есть проблемы — дописать в `discussions/T001.md`:**

```markdown
---

## [YYYY-MM-DD HH:MM] {имя_агента} (тестировщик)

### Результат тестирования: ❌ ВОЗВРАТ НА ДОРАБОТКУ

#### Проверенные критерии
- [✓] Критерий 1: OK
- [✗] Критерий 2: НЕ ВЫПОЛНЕН
- [✓] Критерий 3: OK

#### Найденные баги

##### Баг 1: Краткое описание
**Серьёзность**: Critical / High / Medium / Low
**Шаги воспроизведения**:
1. Шаг 1
2. Шаг 2
3. Шаг 3

**Ожидаемый результат**: что должно быть
**Фактический результат**: что происходит
**Файл**: path/to/file.py:123

#### Что нужно исправить
- Пункт 1
- Пункт 2
```

```bash
python .tayfa/common/task_manager.py result T001 "❌ Возврат. См. .tayfa/common/discussions/T001.md"
python .tayfa/common/task_manager.py status T001 в_работе
```

**Чек-лист тестировщика:**
- [ ] Проверен каждый acceptance criterion
- [ ] Проверены edge cases
- [ ] Баги описаны со шагами воспроизведения
- [ ] Указана серьёзность багов

### Просмотр задач

```bash
python .tayfa/common/task_manager.py list                    # все задачи
python .tayfa/common/task_manager.py list --status в_работе  # по статусу
python .tayfa/common/task_manager.py list --sprint S001      # задачи спринта
python .tayfa/common/task_manager.py get T001                # одна задача
```

---

## Единый реестр сотрудников

Источник правды — **`.tayfa/common/employees.json`**. Оркестратор показывает только зарегистрированных.

- Новые сотрудники — **только** через `python .tayfa/hr/create_employee.py <имя>`.
- Просмотр: `python .tayfa/common/employee_manager.py list`
- Изначально: `boss`, `hr`.

**Не редактируй `employees.json` вручную** — используй скрипты.

---

## Структура папки сотрудника

У каждого сотрудника:

```
.tayfa/<имя>/
├── prompt.md      # Системный промпт агента
├── profile.md     # Профиль: навыки, специализация
└── skills/        # Навыки агента (SKILL-*.md)
```

### Папка skills/

В папке `.tayfa/<имя>/skills/` хранятся навыки сотрудника — файлы `SKILL-*.md`.

**Важно:** Агент должен **использовать свои навыки** при выполнении задач. Навыки содержат методологии, шаблоны и лучшие практики.

Пример:
```
.tayfa/boss/skills/
├── SKILL-task-decomposer.md    # Декомпозиция задач
├── SKILL-team-assignment.md    # Назначение исполнителей
└── SKILL-project-tracking.md   # Отслеживание прогресса
```

---

## Правила

- **Задачи** — через `.tayfa/common/task_manager.py`. Все задачи в `.tayfa/common/tasks.json`.
- **Все задачи привязаны к спринту** — при создании указывай `--sprint S001`.
- **Спринты** — через `.tayfa/common/task_manager.py create-sprint`.
- **Сотрудники** — через `.tayfa/common/employee_manager.py` и `.tayfa/hr/create_employee.py`.
- **Общение по задачам** — в `.tayfa/common/discussions/{task_id}.md`.
- **Навыки** — используй файлы из `.tayfa/<имя>/skills/` при выполнении задач.
- Артефакты проекта — в корне проекта; коммуникация — в `.tayfa/`.

### Предложения изменений в код

Если сотрудник (агент) хочет предложить изменения в коде системы (task_manager.py, orchestrator, правила и т.д.) — **он НЕ делает изменения напрямую**, а:

1. **Добавляет запись в бэклог**:
   ```bash
   python .tayfa/common/backlog_manager.py add "Описание предложения" \
     --description "Подробное описание: что, зачем, как" \
     --priority medium \
     --created-by <имя_агента>
   ```

2. **Boss рассматривает** предложение при планировании спринта

3. **Если одобрено** — boss создаёт задачу из бэклога

**Почему так:**
- Сотрудники не должны самовольно менять инфраструктуру
- Boss видит все предложения централизованно
- Можно приоритизировать и планировать изменения
- История предложений сохраняется

---

## Пример рабочего цикла

```
1. Boss создаёт спринт:
   python .tayfa/common/task_manager.py create-sprint "Парсинг API" "Реализовать парсер внешнего API"
   → Создан S001, автоматически создана задача «Финализировать спринт»

2. Boss создаёт задачи в спринте:
   python .tayfa/common/task_manager.py create "Написать парсер" "Парсер для API" \
     --customer analyst --developer developer_python --tester qa_tester --sprint S001
   → Создана T002, привязана к S001

3. Оркестратор: кнопка «Постановщик детализирует» → analyst:
   python .tayfa/common/task_manager.py result T002 "Подробные требования..."
   python .tayfa/common/task_manager.py status T002 в_работе

4. Оркестратор: кнопка «Разработчик выполняет» → developer_python:
   python .tayfa/common/task_manager.py result T002 "Готово, src/parser.py"
   python .tayfa/common/task_manager.py status T002 на_проверке

5. Оркестратор: кнопка «Тестировщик проверяет» → qa_tester:
   python .tayfa/common/task_manager.py result T002 "Всё работает"
   python .tayfa/common/task_manager.py status T002 выполнена

6. Все задачи выполнены → финализируем спринт через задачу «Финализировать спринт»
```

---

---

## Тестирование

### Классификация тестов

| Тип | Характеристика | Когда запускать |
|-----|----------------|-----------------|
| **Быстрые** (unit, integration без UI) | Не мешают пользователю | На каждый коммит, перед `на_проверке` |
| **Медленные** (E2E, UI-автотесты) | Захватывают мышь/клавиатуру | По запросу, перед релизом |

### Definition of Done (тесты)

Задача считается выполненной, если:
- ✅ Быстрые тесты проходят
- ✅ Новый код покрыт unit-тестами (где применимо)
- ✅ Существующие тесты не сломаны

### Медленные тесты — предупреждение пользователя

⚠️ Перед запуском E2E-тестов **обязательно предупреди пользователя**:

```
⚠️ Внимание: Запускаю E2E-тесты.
Тесты будут управлять мышью/клавиатурой.
Не трогайте компьютер до завершения.
```

### Структура тестов

```
tests/
├── fast/                 # Быстрые тесты (запускать всегда)
│   ├── unit/
│   └── integration/
└── slow/                 # Медленные тесты (по запросу)
    └── e2e/
```

Или через маркеры: `pytest -m "not slow"` (только быстрые).

---

## Архивация спринтов

### Цель

После завершения спринта данные архивируются:
- **Агенты НЕ видят** архив (не засоряет контекст)
- **Пользователь может достать** историю при необходимости

### Структура архива

```
.tayfa/common/archive/
├── S001/
│   ├── sprint.json      # Данные спринта
│   └── tasks.json       # Задачи спринта (snapshot)
├── S002/
└── ...
```

### Когда архивируется

Автоматически при финализации спринта:
1. Все задачи спринта в статусе `выполнена` или `отменена`
2. Задача "Финализировать спринт" переводится в `выполнена`
3. Выполняется релиз (merge, tag, push)
4. → Спринт архивируется

### Правила для агентов

⛔ **ЗАПРЕЩЕНО**: читать файлы из `.tayfa/common/archive/`

✅ **РАЗРЕШЕНО**: работать только с `.tayfa/common/tasks.json` (активные задачи)

**Почему**: Архив — история для человека. Агентам важны только активные задачи.

---

## Продуктовая документация

При значительных изменениях продукта обновляй `docs/product/`.

### Когда обновлять

| Обновлять | НЕ обновлять |
|-----------|--------------|
| Новая фича | Рефакторинг без изменения поведения |
| Изменение поведения | Исправление багов |
| Новый пользовательский сценарий | Оптимизация производительности |
| Изменение API контракта | Мелкие UI-твики |

### Ответственный

**Analyst** (постановщик) проверяет необходимость обновления при:
1. Детализации задачи (перед `в_работе`)
2. Финализации спринта

См. детали в `.tayfa/common/Rules/product-docs.md`.

---

## Git Workflow

Проект ведётся в Git. **Коммиты делает оркестратор автоматически**, агентам не нужно выполнять git-команды.

### Структура веток

```
main (стабильная версия)
  │
  └── sprint/S001 (ветка спринта)
        ├── коммит: T001 — Заголовок задачи
        ├── коммит: T002 — Заголовок задачи
        └── финализация → merge в main + tag vX.Y.Z
```

### Автоматические действия оркестратора

| Событие | Действие оркестратора |
|---------|----------------------|
| Создание спринта | Создать ветку `sprint/S001` |
| Задача → `на_проверке` | `git add -A && git commit -m "T001: Заголовок"` |
| Финализация спринта | Merge в main + тег `vX.Y.Z` + push |

### Что делают агенты

Агенты **не выполняют git-команды**. Они только:
1. Выполняют работу по задаче
2. Записывают результат через `task_manager.py result`
3. Меняют статус через `task_manager.py status`

Коммит произойдёт автоматически при смене статуса на `на_проверке`.
